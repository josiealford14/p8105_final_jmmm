---
title: "p8105_final_jmmm"
author: "MeOak/Muhire/Manali/Josie"
date: "10/31/2017"
output: html_document
---

```{r project_website}
#project website. can you see it? https://josiealford14.github.io/therealcostofdrugs/
```

```{r load_packages, message = FALSE}
library(tidyverse)
library(dplyr)
library(rvest)
library(httr)
library(janitor)
library(stringr)
library(forcats)
library(tidytext)
library(viridis)
library(broom)
library(plotly)
```

### **Dataset 1: Drug Prices**

* Looking at the National Drug Acquisition Cost dataset:

```{r tidy_drug_price}

# # API code
# url = "https://data.medicaid.gov/resource/tau9-gfwr.csv"
# drug_price =
#   GET(url, query = list("$limit" = 9999999)) %>%
#   content("parsed") %>%
#   clean_names()

# # CSV code
drug_price =
  read_csv("../data/drug_price.csv") %>%
  clean_names()
```

* The raw `drug_price` dataset is huge and takes a while to load.
* It contains weekly drug prices from november 2013 to october 2017 recorded. There are `r drug_price %>% nrow()` observations and `r drug_price %>% ncol()` variables in the dataset:
    + `as_of_date`: date of data posting
    + `classification_for_rate_setting`: indicates whether, for NADAC calculation, the NDC was considered brand (‘B’) or generic (‘G’) or brand (‘B’) approved under an Abbreviated New Drug Application (ANDA) (‘B-ANDA’).
    + `corresponding_generic_drug_effecitve_date`:  effective date of when the Corresponding Generic Drug NADAC Per Unit is assigned to a multiple source brand drug NDC
    + `corresponding_generic_drug_nadac_per_unit`: NADAC for the corresponding generic drug
    + `effective_date`: effective date of the NADAC Per Unit cost
    + `explanation_code`: codes that pertain to how the NADAC was calculated. see explanation code
descriptions [here](https://www.medicaid.gov/medicaid-chip-program-information/by-topics/prescription-drugs/ful-nadac-downloads/nadacdatadefinitions.pdf)
    + `nadac_per_unit`: National Average Drug Acquisition Cost per unit
    + `ndc`:  11-digit FDA code that includes the labeler code, product code, and package code
    + `ndc_description`: drug name, strength, and dosage form of the drug 
    + `otc`: over-the-counter (OTC) product (‘Y’ or ‘N’)
    + `pharmacy_type_indicator`: source of pharmacy survey data used to calculate the NADAC. ‘ C/I’ indicates data was collected from surveys of Chain/Independent pharmacies. Other pharmacy type indicators are not used at this time.
    + `pricing_unit`:  pricing unit for the associated NDC (‘ML’, ‘GM’ or ‘EA’)
* We will focus on the variables `effective_date`, `ndc`, `ndc_description`, `otc`, `classification_for_rate_setting`, `pricing_unit`, and `nadac_per_unit`. We will rename the variables `effective_date`, `ndc_description`, `classification_for_rate_setting`, and `nadac_per_unit` as `date`, `drug_name`, `drug_type`, and `unit_price` respectively. We will also split the `date` variable into the `year`, `month` and `date` variables.

```{r rename_split_date}
drug_price = 
  drug_price %>%
  rename(trade_name = ndc_description,
         drug_type = classification_for_rate_setting,
         unit_price = nadac_per_unit) %>%
  mutate(trade_name = str_replace(trade_name, "[0-9]", "_"),
         trade_name = str_to_title(trade_name),
         otc = recode(otc, "Y" = "yes", "N" = "no"),
         otc = str_to_title(otc),
         otc = as.factor(otc)) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = "_") %>% 
  separate(effective_date, into = c("year", "month", "date")) %>%
  select(-c(date, x1, remove)) %>%
  mutate(trade_name = trimws(trade_name, which = c("both"))) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = " ") %>% 
  filter(is.na(remove)) %>%
  select(-remove) %>% 
  filter(pricing_unit == "GM" | pricing_unit == "EA") %>% 
  select(trade_name, everything()) 
```

* We look at the yearly distribution of drug prices for a few drugs. Some drugs have skewed price distributions and the median (instead of the mean) price might be the better measure to use in the analyses. Also, it might be worth creating a shiny app for people to view the price distributions for various drugs.

```{r drug_price_distr}
drug_price %>%
  filter(trade_name == "Abacavir") %>%
  ggplot(aes(x = year, y = unit_price)) + geom_violin(aes(fill = year), color = "blue", alpha = .5)
```

```{r}
new_drug_price = drug_price %>% 
  group_by(trade_name, drug_type, otc, pricing_unit, year) %>% 
  summarize(avg_price = mean(unit_price, na.rm = TRUE))

new_drug_price
```



* **Points to consider:**
    + Some unit prices are listed as price per grams or price per milliliters or price per tablet We need to create a price variable with the appropriate unit price if we want to compare drug prices. One way to do this is to convert all unit prices to price per grams by dividing the price of each tablet by the tablet weight and by using the approximate relationship 1ml = 1gm.

### **Dataset 2: Funding for Research**

* The NIH RCDC Report
* This dataset contains the annual support for various disease categories based on grants, contracts, and other funding mechanisms used across the National Institutes of Health (NIH).  Prevalence and mortality data included in this dataset is from the National Center for Health Statistics (NCHS) at the Centers for Disease Control & Prevention (CDC).
*Funding for 2018 are estimated figures.
```{r load_funding}
url = "https://report.nih.gov/categorical_spending.aspx"
NIH_xml = read_html(url)
NIH_funding = (NIH_xml %>% html_nodes(css = "table"))[[3]] %>% html_table() %>% as_tibble()
NIH_funding = NIH_funding %>%
  clean_names() %>%
  mutate(US_mortality_2015 = x2015_us_mortality_19)

NIH_funding$x2015_us_prevalence_standard_error_19  = recode(NIH_funding$x2015_us_prevalence_standard_error_19 , "-" = "NA")
NIH_funding$US_mortality_2015 = recode(NIH_funding$US_mortality_2015, "-" = "NA")

NIH_funding = NIH_funding %>%
  separate(x2015_us_prevalence_standard_error_19, into = c("prevalence", "remove"), sep = "\\%") %>%
  select(-x2015_us_mortality_19, -remove)
NIH_funding$fy_2013actual = recode(NIH_funding$fy_2013actual, "+" = "NNA")
NIH_funding$fy_2014actual = recode(NIH_funding$fy_2014actual, "+" = "NNA")
NIH_funding$fy_2015actual = recode(NIH_funding$fy_2015actual, "+" = "NNA")
NIH_funding$fy_2016actual = recode(NIH_funding$fy_2016actual, "+" = "NNA")

NIH_funding = NIH_funding %>%
  mutate(fy_2013 = as.numeric(substring(fy_2013actual, 2))) %>%
  mutate(fy_2014 = as.numeric(substring(fy_2014actual, 2))) %>%
  mutate(fy_2015 = as.numeric(substring(fy_2015actual, 2))) %>%
  mutate(fy_2016 = as.numeric(substring(fy_2016actual, 2))) %>%
  mutate(fy_2017 = as.numeric(substring(fy_2017estimated_enacted, 2))) %>%
  mutate(fy_2018estimated = as.numeric(substring(fy_2018estimated, 2))) 

NIH_funding$prevalence = as.numeric(NIH_funding$prevalence)
NIH_funding$US_mortality_2015 = as.numeric(NIH_funding$US_mortality_2015)
  
NIH_funding = NIH_funding %>%
  select(-c(fy_2013actual, fy_2014actual, fy_2015actual, fy_2016actual, fy_2017estimated_enacted))

final_NIH_funding = NIH_funding %>%
  rename(disease = research_disease_areas_dollars_in_millions_and_rounded, 
         '2013' = fy_2013,
         '2014' = fy_2014,
         '2015' = fy_2015,
         '2016' = fy_2016,
         '2017' = fy_2017,
         '2018' = fy_2018estimated) %>%
  gather(key = "year", value = funding, c("2013", "2014", "2015", "2016", "2017", "2018")) %>% 
  mutate(disease = str_replace(disease, "[0-9]", "_"),
         disease = str_replace(disease, "\\-", ""),
         disease = str_replace(disease, "ALS", "Amyotrophic Lateral Sclerosis"),
         disease = str_replace(disease, "Sleep Research", "Sleep Disorders"),
         disease = str_replace(disease, "Smoking and Health", "Smoking Cessation")) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\_") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\(") %>% 
  select(-remove)

rm(NIH_funding)

final_NIH_funding
```

### **Dataset 3: Patents**

* The Patents dataset from the FDA Orange Book
* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* New Drug Application Type: The type of new drug application approval, either New Drug Applications(NDA or innovator) or Abbreviated New Drug Applications(ANDA or generic)

* New Drug Application (NDA) Number (appl_no) : The FDA assigned number to the application. 

* Product Number: The FDA assigned number to identify the application products.  Each strength is a separate product.  May repeat for multiple part products. 

* Patent Number (patent_num): Patent numbers as submitted by the applicant holder for patents covered by the statutory provisions.  May repeat for multiple applications and multiple products. 

* Pediatric Exclusivity Granted: Yes or No.  Was pediatric exclusivity granted by the agency?

* Patent Expire Date: The date the patent expires as submitted by the applicant holder including applicable extensions.  This was split into Year, Month, and Day variables

* Drug Substance Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug substance flag indicating the sponsor submitted the patent as claiming the drug substance.   

* Drug Product Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug product flag indicating the sponsor submitted the patent as claiming the drug product.   

* Patent Use Code: Code to designate a use patent that covers the approved indication or use of a drug product.  May repeat for multiple applications, multiple products and multiple patents.

* Patent Delist Request Flag: Sponsor has requested patent be delisted.  This patent has remained listed because, under Section 505(j)(5)(D)(i) of the Act, a first applicant may retain eligibility for 180-day exclusivity based on a paragraph IV certification to this patent for a certain period.  Applicants under Section 505(b)(2) are not required to certify to patents where this flag is set to Y.

```{r load_patents}
patents = read_csv("./data/patent.csv")
patents = patents %>% 
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "N" = "B")) %>%
  separate(patexp, into = c("month_pat_expires", "day_pat_expires", "year_pat_expires"), sep = "/") %>%
  separate(patent_no, into = c("patent_num", "pediatric_exclusivity_granted"), sep = "\\*")

patents$pediatric_exclusivity_granted[is.na(patents$pediatric_exclusivity_granted)] = "no"
patents$drugsub[is.na(patents$drugsub)] = "no"
patents$drugprod[is.na(patents$drugprod)] = "no"
patents$delist[is.na(patents$delist)] = "no"

patents = patents %>%
  mutate(pediatric_exclusivity_granted = factor(pediatric_exclusivity_granted, levels = c("no", "PED"), labels = c("No", "Yes"))) %>%
  mutate(drug_substance_flag = factor(drugsub, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(drug_prod_flag = factor(drugprod, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(patent_delisted = factor(delist, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  select(-drugsub, -drugprod, -patexpstr) %>%
  rename(pat_use_code = patuse)
patents
```

### **Dataset 4: Products**

*The Products dataset from the FDA Orange Book

* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* Ingredient: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

* Dose form;The product dosage form

* Route:  Product dosage route 

* Trade_Name: The trade name of the product as shown on the labeling.

* Applicant: The firm name holding legal responsibility for the new drug application.  The firm name is condensed to a maximum twenty character unique string.

* Strength: The potency of the active ingredient.  May repeat for multiple part products.

* Drug Application Type: The type of new drug application approval. NDA orANDA as for patents dataset.

* New Drug Application (NDA) Number: The FDA assigned number to the application.

* Product Number: The FDA assigned number to identify the application products. Each strength is a separate product.  May repeat for multiple part products.

* Therapeutic Equivalence (TE) Code: The TE Code indicates the therapeutic equivalence rating of generic to innovator Rx products.

* Approval Date: The date the product was approved as stated in the FDA approval letter to the applicant. Products approved prior to the January 1, 1982 contain the phrase: "Approved prior to Jan 1, 1982".  This separated into Year, Month, and Day variables.

* Reference Listed Drug (RLD) Updated: The RLD is a drug product approved under section 505(c) of the FD&C Act for which FDA has made a finding of safety and effectiveness. In the electronic Orange Book, an RLD is identified by “RLD” in the RLD column.

* Reference Standard (RS) New! :A “reference standard” is the drug product selected by FDA that an applicant seeking approval of an ANDA must use in conducting an in vivo bioequivalence study required for approval of an ANDA.  In the electronic Orange Book, a reference standard is identified by “RS” in the RS column.

*Type: The group or category of approved drugs. RX (prescription), OTC (over the counter), or DISCN (discontinued).

*Applicant Full Name: The full name of the firm holding legal responsibility for the new drug application. 

```{r load_products}
products = read_csv("./data/products.csv")
products = products %>%
  rename(drug_type = appl_type,
         otc = type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B"),
         otc = recode(otc, "OTC" = "yes", "RX" = "no", "DISCN" = "no")) %>%
  separate(appdate, into = c("approval_month", "approval_day", "approval_year"), sep = "/") %>%
  #separate(doseform, into = c("form", "release_type"), sep = ",")
  mutate(otc = factor(otc)) %>%
  mutate(ref_listed_drug = factor(rld)) %>%
  mutate(ref_std = factor(rs)) %>%
  select(-appdatestr, -rld, -rs, -dfroute)
products
```

### **Dataset 5: Exclusivity**

We load and tidy the `exclusivity` dataset

```{r tidy_exclusivity}
exclusivity = read_csv("./data/exclusivity.csv") %>%
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B")) %>% 
  separate(excldate, into = c("month_excl_expires", "date_excl_expires", "year_excl_expires"))
exclusivity
```

The tidied `exclusivity` dataset has `r exclusivity %>% nrow` observations and `r exclusivity %>% ncol` variables:

* `year`, `month`, and `date` the exclusivity expires
* `appl_type`: type of new drug application approval. New Drug Applications (NDA or innovator) are "N". Abbreviated New Drug Applications (ANDA or generic) are “A”.
* `appl_no`: FDA assigned number to the application.  Format is nnnnnn.
* `product_no`: FDA assigned number to identify the application products. Each strength is a separate product. May repeat for multiple part products.  Format is nnn.
* `exclcode`: Code to designate exclusivity granted by the FDA to a drug product.  Format is nnnnnnnnnn.
* `excldatestr`: The date the exclusivity expires. Format is MMM DD, YYYY.

### **Dataset 6: Ingredient**

We load the `ingredient` dataset. 

```{r tidy_ingredients}
ingredient = read_csv("./data/ingredient.csv") %>%
  clean_names() %>%
  select(singnum, singredient, everything())
ingredient
```

The tidied `ingredient` dataset has `r ingredient %>% nrow` observations and `r ingredient %>% ncol` variables:

* `singnum`: The number assigned to the single ingredient for each product.
* `singredient`: each single ingredient in the product.
* `ingredient`: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

### **Dataset 7: Drug by Condition**

Scraping data on drugs per condition from [this website](https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/A)

```{r scrape_drug_disease}

urls = paste("https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/", toupper(letters), sep = "")

get_drug_disease = function(url) {
  
  disease_data = read_html(url) %>% 
  html_nodes(css = ".ToggleDrugCategory") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(disease = value)
  
  drug_data = read_html(url) %>% 
  html_nodes(css = ".CategoryListSection a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug = value)
  
  drug_disease_data = read_html(url) %>% 
  html_nodes(css = "#MainColumn a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug_disease = value)
  
  drug_disease_joined = left_join(drug_disease_data, drug_data, disease_data, by = "key") %>% 
  left_join(., disease_data, by = "key") %>%
  fill(disease) %>%
  select(-c(drug,drug_disease))
  
  toremove = drug_disease_joined %>% distinct(disease) %>% pull()
  
  drug_disease_joined = drug_disease_joined %>% 
  filter(!key %in% toremove) %>% 
  rename(drug = key) %>% 
  .[-c(1:29),]
  
  drug_disease_joined
}

drug_disease_data = map_df(urls, get_drug_disease) %>% 
  mutate(disease = str_to_title(disease),
         drug = str_to_title(drug)) %>% 
  rename(trade_name = drug) %>%
  mutate(trade_name = trimws(trade_name, which = c("both"))) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = " ") %>% 
  select(-remove)

drug_disease_data
```

The `drug_disease_data` contains `r drug_disease_data %>% nrow` observations and `r drug_disease_data %>%  ncol` variables:

* `drug`: the drug name
* `disease`: the disease name

### Combine Datasets into one 

```{r join_dataset}

#A: join datasets by ingredient for ingredient and products (left join)
#products = longer dataset + ingredient
product_ingredient = left_join(products, ingredient, by = "ingredient")
product_ingredient

#B: exclusivity and patents left join (more~less)
patent_exclusivity = left_join(patents, exclusivity, by = c("appl_no", "product_no", "drug_type"))
patent_exclusivity

#C: join A and B left join: "Orange Book." Thursday: meet to eliminate variables (inner join: only commonalities are preserved) #eliminate drugs that do not match
orange_book = left_join(product_ingredient, patent_exclusivity, by = c("appl_no", "product_no", "drug_type"))

orange_book = orange_book %>%
  mutate(ingredient = str_to_title(ingredient),
         doseform = str_to_title(doseform),
         route = str_to_title(route),
         trade_name = str_to_title(trade_name),
         applicant = str_to_title(applicant),
         otc = str_to_title(otc),
         appfull = str_to_title(appfull),
         singredient = str_to_title(singredient),
         strength = str_to_title(strength))
orange_book

# final goal: disease, funding, drug prices, and Orange Book

# eliminate unnecessary variables from orange book dataset
orange_book_clean = orange_book %>%
  rename(application_no = appl_no, 
         active_ingredient = singredient, 
         dose_form = doseform) %>%
  select(-c(ingredient, applicant, product_no, tecodestr, tecode, approval_day, ref_std, singnum, day_pat_expires, pat_use_code, drug_substance_flag, drug_prod_flag, exclcode, excldatestr, date_excl_expires)) %>% 
  select(trade_name, everything()) %>% 
  separate(dose_form, into = c("dose_form", "remove")) %>%
  filter(is.na(remove)) %>% 
  select(-remove) %>% 
  filter(str_detect(dose_form, regex("Tablet", ignore_case = TRUE))) %>%
  mutate(trade_name = trimws(trade_name, which = c("both")),
         trade_name = str_replace_all(trade_name, ", ", "-"),
         trade_name = str_replace_all(trade_name, " And ", "-"))

# inner join of disease drug and orange book by trade_name
final_dataset =
  new_drug_price %>%
  inner_join(., orange_book_clean, by = c("trade_name", "drug_type", "otc")) %>% 
  distinct() %>% 
  left_join(., drug_disease_data, by = "trade_name") %>% 
  distinct() %>% 
  mutate(disease = str_replace(disease, " And ", "_"),
         disease = str_replace(disease, "High Blood Pressure \\(", ""),
         disease = str_replace(disease, "Copd \\(", ""),
         disease = str_replace(disease, "\\/Hyperactivity", ""),
         disease = str_replace(disease, "\\)", ""),
         disease = str_replace(disease, " Mellitus, Type 2", ""),
         disease = str_replace(disease, " Mellitus Types I", ""),
         disease = str_replace(disease, "Hepatitis", "Hepatitis C"),
         disease = str_replace(disease, "Hepatitis C B", "Hepatitis B"),
         disease = str_replace(disease, "Hepatitis C C", "Hepatitis C"),
         disease = str_replace(disease, "Hiv/Aids", "HIV/AIDS"),
         disease = str_replace(disease, " \\- ", "_"),
         disease = str_replace(disease, "Migraine", "Migraines")
         ) %>%
  separate(disease, into = c("disease", "remove"), sep = "\\_") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\(") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\;") %>%
  select(-remove) %>% 
  left_join(., final_NIH_funding, by = c("disease", "year")) %>%
  as_tibble() %>%
  distinct() %>% 
  mutate(disease = str_replace(disease, "Chronic Obstructive Pulmonary Disease", "Chronic Obstructive Pulmonary Disorder"),
         disease = str_replace(disease, "Kidney Disease", "Chronic Kidney Disease"),
         disease = str_replace(disease, "Cardiac Ischemia", "Coronary Artery Disease"),
         disease = str_replace(disease, "Diabetes", "Diabetes Mellitus Types 1 & 2"),
         disease = str_replace(disease, "Bipolar Disorder", "Bipolar Mood Disorder"))
```

Josie
```{r}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(plotly)
library(lubridate)
library(forcats)
library(stringr)
library(viridis)
library(ggplot2)
library(dplyr)
library(flexdashboard)
library(readxl)
library(janitor)
```

### Do drugs that treat chronic illnesses (diabetes, heart disease, high blood pressure, etc) receive more or less funding, and pricing  compared to acute illnesses? 

## How does pricing and funding compare across diseases (27 unique diseases in our "orange book") regardless of disease type?
```{r Clean Chronic Disease Dataset}
###chronic diseases

#first dataset
chronic_diseases_1_html = read_html("https://www.medicalschemes.com/medical_schemes_pmb/chronic_disease_list.htm")
chronic_diseases_1 = chronic_diseases_1_html %>%
  html_nodes("td td td .maintext") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#second dataset
chronic_diseases_2_html = read_html("http://www.health24.com/Medical-schemes/PMB-and-chronic-disease/List-of-chronic-diseases-20120721")
chronic_diseases_2 = chronic_diseases_2_html %>%
  html_nodes("ul:nth-child(10) li , ul:nth-child(10) a") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#third dataset
chronic_diseases_3_html = read_html("https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Chronic-Conditions/CC_Main.html")
chronic_diseases_3 = chronic_diseases_3_html %>%
  html_nodes("td") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#final chronic disease dataset
chronic_diseases = rbind(chronic_diseases_1, chronic_diseases_2, chronic_diseases_3) %>%
  distinct()

#recode diseases
chronic_diseases$disease[62] = "Cancer"
chronic_diseases$disease[67] = "High Blood Pressure"
chronic_diseases$disease[43] = "High cholesterol"
chronic_diseases$disease[60] = "Austism"
chronic_diseases$disease[55] = "Arthritis"
chronic_diseases$disease[46] = "Hypothyroidism"
chronic_diseases$disease[38] = "Dysrhythmia"
chronic_diseases$disease[66] = "inactive thyroid gland"
chronic_diseases$disease[53] = "alzheimer's disease"
chronic_diseases$disease[26] = "Dementia"
chronic_diseases$disease[56] = "Hepatitis"
chronic_diseases$disease[71] = "COPD"

#need to include breast cancer, hepatitis b, hepatitis c, lung cancer, prostate cancer bc chronic disease set does not specify
#hepatitis
hepatitis_chronic = final_dataset %>%
  filter(str_detect(disease, regex("hepatitis", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#cancer
cancer_chronic = final_dataset %>%
  filter(str_detect(disease, regex("cancer", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#hiv/aids
hiv_aids_chronic = final_dataset %>%
  filter(str_detect(disease, regex("hiv", ignore_case = TRUE)) | str_detect(disease, regex("aids", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#combine hepatitis, cancer and hiv/aids with chronic diseases
chronic_diseases = rbind(chronic_diseases, hepatitis_chronic, cancer_chronic, hiv_aids_chronic)
chronic_diseases = chronic_diseases %>%
  unique()

#indicator of chronic disease
indicator_chronic_disease = vector()
indicator_chronic_disease[1:nrow(chronic_diseases)] = c("yes")
indicator_chronic_disease = as.tibble(indicator_chronic_disease)

#final chronic disease dataset with indicator column (y/n)
chronic_diseases_final = cbind(chronic_diseases, indicator_chronic_disease) %>%
  rename(chronic_disease = value) 

#formatting for exact matching
final_dataset$disease = trimws(final_dataset$disease, which = "right")
chronic_diseases_final$disease = trimws(chronic_diseases_final$disease, which = "both")
final_dataset$disease = tolower(final_dataset$disease)
chronic_diseases_final$disease = tolower(chronic_diseases_final$disease)

# Join final dataset and chronic disease dataset to complete analysis.
final_dataset = left_join(final_dataset,chronic_diseases_final, by = "disease")
final_dataset$chronic_disease[is.na(final_dataset$chronic_disease)] = "no"
final_dataset = final_dataset %>%
  mutate(disease_type = recode(chronic_disease, 'no' = "acute", 'yes' = "chronic")) #%>%
  #select(everything(), -chronic_disease.x, -chronic_disease.y)

rm(chronic_diseases, indicator_chronic_disease, cancer_chronic, hepatitis_chronic, hiv_aids_chronic, chronic_diseases_1, chronic_diseases_2, chronic_diseases_3, chronic_diseases_1_html, chronic_diseases_2_html, chronic_diseases_3_html, chronic_diseases_final) #clean up workspace
```

### FUNDING
```{r Chronic Disease Analysis: Funding of Diseases: Summary}
#Let's examine funding based on whether or not a disease is chronic or acute

### EXPLORATORY ANALYSIS
#Summary Statistics for Funding: Chronic Disease vs. Acute Disease (by disease-->we have 27 unique diseases)
summary_funding_individual_diseases = final_dataset %>%
  filter(!is.na(disease)) %>% #exclude orange book entries without a disease entry
  group_by(disease_type, disease) %>% #this line and upward is general for chronic disease analysis
  filter(!is.na(funding)) %>%
  summarize(n = n(), mean = mean(funding), median = median(funding), standard_deviation = sd(funding), minimum = min(funding), maximum = max(funding)) 

#Which disease (top 3) has the highest median funding (by disease type)? 
max_funding_individual_diseases = summary_funding_individual_diseases %>%
  filter(min_rank(desc(median)) < 4)

#Which disease (bottom 3) has the lowest median funding (by disease type)? 
min_funding_individual_diseases = summary_funding_individual_diseases %>%
  filter(min_rank(median) < 4)

#Summary Statistics for Funding: Chronic Disease vs. Acute Disease (by disease type)
summary_funding_disease_type = final_dataset %>%
  filter(!is.na(disease)) %>% #exclude orange book entries without a disease entry
  group_by(disease_type) %>% #this line and upward is general for chronic disease analysis
  filter(!is.na(funding)) %>%
  summarize(n = n(), mean = mean(funding), median = median(funding), standard_deviation = sd(funding), minimum = min(funding), maximum = max(funding)) 

#Summary Statistics for Funding: Disease in General
summary_funding_by_disease = final_dataset %>%
  filter(!is.na(disease)) %>% #exclude orange book entries without a disease entry
  group_by(disease) %>% #this line and upward is general for chronic disease analysis
  filter(!is.na(funding)) %>%
  summarize(n = n(), mean = mean(funding), median = median(funding), standard_deviation = sd(funding), minimum = min(funding), maximum = max(funding)) 

#Which disease (top 3) has the highest median funding? 
max_funding = summary_funding_by_disease %>%
  filter(min_rank(desc(median)) < 4)

#Lowest funding (lowest 3)?
min_funding = summary_funding_by_disease %>%
  filter(min_rank(median) < 4)
```

```{r Chronic Disease Analysis: Funding of Diseases: Plots}
#Graphs for Funding (PLOT_LY!)
# 1. Diseases with higest median funding (grouped by disease_type) (top 3) (bar chart) NEED HELP REARRANGING FROM SMALLEST TO LARGEST
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  # mutate(disease = fct_infreq(disease),
  #        disease_type = fct_infreq(disease_type)) %>%
  group_by(disease_type, disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(desc(median)) < 4) %>%
  plot_ly(x = ~disease, y = ~median, color = ~disease_type, type = "bar")
  
  #possible help?
  # mutate(cuisine_description = fct_reorder(cuisine_description, score)) %>%
  # group_by(cuisine_description, grade) %>%
  # summarize(mean_score = mean(score)) %>%
  # plot_ly(x = ~cuisine_description, y = ~mean_score, color = ~grade, type = "bar")
  
# 2. Diseases with lowest median funding (bottom 3) (bar chart)
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  group_by(disease_type, disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(median) < 4) %>%
  plot_ly(x = ~disease, y = ~median, color = ~disease_type, type = "bar", colors = "Set2")

# 1A. Overall: Diseases with highest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  # mutate(disease = fct_infreq(disease)) %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 2A. Overall: Diseases with lowest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 1B. Acute Diseases with highest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "acute") %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 1C. Chronic Diseases with highest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "chronic") %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 2B. Acute Diseases with lowest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "acute") %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set1")

# 2C. Chronic Diseases with lowest median funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "chronic") %>%
  group_by(disease) %>% 
  summarize(median = median(funding)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set3")

# 3. Funding by disease status (boxplot)
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  mutate(disease_type = fct_reorder(disease_type, funding)) %>%
  group_by(disease_type) %>% 
  plot_ly(y = ~funding, type = "box", color = ~disease_type, colors = "Set3")

# 4. Funding by disease status & disease (boxplot)

#by most orange book entries (Could try by prevalence)
most_entries_diseases = final_dataset %>%
  group_by(disease_type) %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  count(disease, sort = TRUE) %>%
  top_n(3) %>%
  select(disease)

final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  inner_join(most_entries_diseases) %>%
  # mutate(disease_type = fct_reorder(disease_type, funding), 
  #        disease = fct_reorder(disease)) %>%
  group_by(disease) %>% 
  plot_ly(y = ~funding, type = "box", color = ~disease, colors = "Set3")

#by prevalence NOT WORKING!
# most_prevalent_diseases = final_dataset %>%
#   group_by(disease, disease_type) %>%
#   filter(!is.na(disease) & !is.na(funding) & !is.na(funding)) %>%
#   filter(min_rank(desc(prevalence)) < 4) %>%
#   select(disease)
  
# 5. Prevalence vs. Median Funding based on Disease Type. Do more prevalent Chronic or Acute Diseases receive more funding?
#line graph
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  group_by(disease_type, prevalence) %>% 
  summarize(median_funding = median(funding)) %>%
  plot_ly(x = ~prevalence, y = ~median_funding, type = "scatter", mode = "lines", color = ~disease_type, colors = "Set1")
  
#scatter plot
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  group_by(disease_type, disease, prevalence) %>% 
  summarize(median_funding = median(funding)) %>%
  plot_ly(x = ~prevalence, y = ~median_funding, type = "scatter", color = ~disease_type, colors = "Set1")
```


###PRICING
```{r Chronic Disease Analysis: Pricing of Drugs: Summary}
summary_pricing_individual_diseases = final_dataset %>%
  filter(!is.na(disease)) %>% 
  group_by(disease_type, disease) %>% 
  filter(!is.na(avg_price)) %>%
  summarize(n = n(), mean = mean(avg_price), median = median(avg_price), standard_deviation = sd(avg_price), minimum = min(avg_price), maximum = max(avg_price)) 

#Which disease (top 3) has the highest median pricing (by disease type)? 
max_price_individual_diseases = summary_pricing_individual_diseases %>%
  filter(min_rank(desc(median)) < 4)

#Which disease (bottom 3) has the lowest median pricing (by disease type)? 
min_price_individual_diseases = summary_pricing_individual_diseases %>%
  filter(min_rank(median) < 4)

#Summary Statistics for Pricing: Chronic Disease vs. Acute Disease (by disease type)
summary_pricing_disease_type = final_dataset %>%
  filter(!is.na(disease)) %>% 
  group_by(disease_type) %>% 
  filter(!is.na(avg_price)) %>%
  summarize(n = n(), mean = mean(avg_price), median = median(avg_price), standard_deviation = sd(avg_price), minimum = min(avg_price), maximum = max(avg_price))  

#Summary Statistics for Pricing: Disease in General
summary_pricing_by_disease = final_dataset %>%
  filter(!is.na(disease)) %>% 
  group_by(disease) %>% 
  filter(!is.na(avg_price)) %>%
  summarize(n = n(), mean = mean(avg_price), median = median(avg_price), standard_deviation = sd(avg_price), minimum = min(avg_price), maximum = max(avg_price)) 

#Which disease (top 3) has the highest median pricing? 
max_pricing = summary_pricing_by_disease %>%
  filter(min_rank(desc(median)) < 4)

#Lowest pricing (lowest 3)?
min_pricing = summary_pricing_by_disease %>%
  filter(min_rank(median) < 4)
```

```{r Chronic Disease Analysis: Pricing of Drugs: Plots}
#Graphs for Pricing (PLOT_LY!)
# 1. Diseases with higest median pricing (grouped by disease_type) (top 3) (bar chart) NEED HELP REARRANGING FROM SMALLEST TO LARGEST
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  group_by(disease_type, disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(desc(median)) < 4) %>%
  plot_ly(x = ~disease, y = ~median, color = ~disease_type, type = "bar")
  
# 2. Diseases with lowest median pricing (bottom 3) (bar chart)
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  group_by(disease_type, disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(median) < 4) %>%
  plot_ly(x = ~disease, y = ~median, color = ~disease_type, type = "bar")

# 1A. Overall: Diseases with highest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  # mutate(disease = fct_infreq(disease)) %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 2A. Overall: Diseases with lowest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 1B. Acute Diseases with highest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price) & disease_type == "acute") %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 1C. Chronic Diseases with highest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price) & disease_type == "chronic") %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(desc(median)) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set2")

# 2B. Acute Diseases with lowest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price) & disease_type == "acute") %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set1")

# 2C. Chronic Diseases with lowest median Pricing
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price) & disease_type == "chronic") %>%
  group_by(disease) %>% 
  summarize(median = median(avg_price)) %>%
  filter(min_rank(median) < 6) %>%
  plot_ly(x = ~disease, y = ~median, type = "bar", color = ~disease, colors = "Set3")

# 3. Pricing by disease status (boxplot)
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  mutate(disease_type = fct_reorder(disease_type, avg_price)) %>%
  group_by(disease_type) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~disease_type, colors = "Set3")

# 4. Pricing by disease status & disease (boxplot)

#by most orange book entries (Could try by prevalence)
most_entries_diseases = final_dataset %>%
  group_by(disease_type) %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  count(disease, sort = TRUE) %>%
  top_n(3) %>%
  select(disease)

final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  inner_join(most_entries_diseases) %>%
  group_by(disease) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~disease, colors = "Set3")
  
# 5. Prevalence vs. Median Pricing based on Disease Type. Do more prevalent Chronic or Acute Diseases have higher average prices?
#line graph
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  group_by(disease_type, prevalence) %>% 
  summarize(median_avg_price = median(avg_price)) %>%
  plot_ly(x = ~prevalence, y = ~median_avg_price, type = "scatter", mode = "lines", color = ~disease_type, colors = "Set1")
  
#scatter plot. the less prevalent a disease, the higher the median_avg price
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  group_by(disease_type, disease, prevalence) %>% 
  summarize(median_avg_price = median(avg_price)) %>%
  plot_ly(x = ~prevalence, y = ~median_avg_price, type = "scatter", color = ~disease_type, colors = "Set1")
```

### For 2016, for a given drug, is how much money spent on advertising correlated with unit price? (funding for 2016, advertising cost dataset).
```{r}
#read in advertising dataset
advertising_cost = read_excel("./data/advertising_cost.xlsx", 
    sheet = "Data", skip = 3) %>%
  clean_names() %>%
  rename(trade_name = leading_pharmaceutical_brands_in_the_united_states_in_2016_by_national_tv_ad_spend_in_million_u_s_dollars, spending_million_dollars = spending_in_million_u_s_dollars)

```

###What about drug sales?
```{r}
top_prescribed_drugs_sales_2016 = read_excel("./data/top_prescribed-drugs-sales-2016.xlsx", 
    sheet = "Data", skip = 3) %>%
  clean_names() %>%
  rename(trade_name = top_20_prescription_drugs_based_on_u_s_sales_in_2016_in_billion_u_s_dollars, sales_billion_dollars = sales_in_billion_u_s_dollars)

```

```{r remove_var}
# Remomve some unecessary datasets
rm(patent_exclusivity, product_ingredient)
```

Manali
```{r}
#do rare diseases recieve less funding?
#set.seed(1)
final_dataset %>%
  #sample_n(50)%>%
  group_by(disease, prevalence) %>%
  #filter(!is.na(disease)) %>%
  #filter(!is.na(prevalence)) %>%
  summarize(total_funding = sum(funding, na.rm = TRUE)) %>%
  plot_ly(x = ~ prevalence, y = ~ total_funding, type = "scatter", color = ~disease)

#does funding correlate with drug prices?

final_dataset %>%
  #sample_n(50)%>%
  group_by(disease, funding, avg_price) %>%
  summarize(avg_funding = mean(funding, na.rm = TRUE)) %>%
  #plot_ly(x = ~funding, y = ~avg_price, type = "scatter")
  plot_ly(x = ~ avg_funding, y = ~ avg_price, type = "scatter")


```

### **Muhire**

We created a spaghetti plot of the average price of drugs per year for each drug. We only used data on prices per drug unit (mainly per tablet). Information about the disease that the drugs treat can be seen by hovering over the plot. We notice that of the drugs with information on price per unit drug, the drugs for Hepatitis C seem to have the highest cost.

**Possible case studies on most popular (perceived) drugs: *Lipitor (Schizophrenia; not in dataset)*, Xanax (Panic Disorders, not in dataset), Celebrex, Prozac, Crestor, Nexium, Lisinopril, Zoloft (Panic Disorders; present in dataset. Almost doubled from 2013 to 2017)**

```{r price_drug_disease}
final_dataset %>% 
  filter(disease %in% c("Panic Disorders")) %>% 
  filter(pricing_unit == "EA" & !is.na(disease)) %>% 
  plot_ly(x = ~year, y = ~avg_price, type = "scatter", mode = "lines", text = ~paste("Drug: ", trade_name, '<br>Disease:', disease), color = ~trade_name, alpha = 0.5) %>% 
  layout(showlegend = FALSE)
```

We also created a scatter plot of the mean NIH funding per drug (assumed to be the same as the NIH funding for disease research) against the demand of the drug (defined as the 2015 disease prevalence) colored by disease. Among drugs with available information on price per unit drug, obesity seems to have received the most funding on average and to have the highest 2015 prevalence.

```{r funding_demand}
final_dataset %>% 
  filter(pricing_unit == "EA" & !is.na(funding) & !is.na(prevalence)) %>% 
  group_by(trade_name, disease, prevalence) %>% 
  summarize(mean_fund = mean(funding)) %>% 
  plot_ly(x = ~prevalence, y = ~mean_fund, type = "scatter", alpha = 1, text = ~paste("Drug: ", trade_name, '<br>Disease:', disease), color = ~disease) %>%
  layout(showlegend = FALSE)
```

MeOak
```{r}

```
