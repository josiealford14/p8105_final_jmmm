---
author: "MeOak/Muhire/Manali/Josie"
date: "12/6/2017"
output:
  html_document: 
    code_folding: hide
title: "Factors Influencing Drug Prices"
---
### **Introduction**


High drug prices have become an increasing concern in the United States (Hancock, 2016 ; "Why Prescription Drugs...”, 2017).  In 2016, 1 in 5 Americans reported taking four or more prescription drugs (“Public Opinion on Prescription…”, 2016). 

This project aims at  exploring factors associated with US prescription drug prices.  Those factors include disease research funding, drug need (prevalence), sales, and advertising. 

### **The Data**

**FDA Orange Book**: This contained 4 datasets: patents, exclusivity, ingredients, and products.

  + Patents: Contains patent number and expiration dates of FDA approved drugs.
  
  + Exclusivity: Contains information on drugs that were granted exclusivity by the FDA.  Exclusivity provides protection from new market competition for a short time.
  
  + Ingredients: Contained information on the active ingredients in drugs.
  
  + Products: Contained the trade name for the drug, the company that developed the drug, and whether the drug was brand or generic.
  
**Drug Price**: This dataset contained the prices paid by pharmacies to acquire the drug.

**NIH Funding**: Contained the NIH finding for disease research areas for 2013 to 2018 (estimated) and the prevalence of the disease.  

**Drug Disease**: Dataset linking drugs was the disease that they treat.


The variables that we retained are: 

* trade_name: the trade name of the drug

* drug_type: the drug type (B: Brand or G: Generic)

* otc: over the counter drug (Yes or No)

* pricing_unit: EA for each, GM for gram, and ML for milliliters

* year: the funding and pricing year

* avg_price: the average price for the particular year

* dose_form: the dose form (tablet, solution, solution injectable)

* route: route of administration (oral or IV)

* strength: the strength of the dose

* application_no: the FDA assigned number to the drug application.

* product_no: The FDA assigned number to identify the application products; used for joining datasets.

* approval_year: the year the patent was approved

* app_full: the full name of the company that developed the drug

* active_ingredient: the active ingredient

* ingredient: the active ingredients in a wide format; used for joining datasets

* patent_num: the patent number

* pediatric_exclusivity_granted: yes or no

* year_pat_expires: the patent expiration year

* year_excl_expires: the exclusivity expiration year

* disease: the disease the drug treats

* prevalence: the disease prevalence for 2015

* US_mortality_2015: the disease mortality rate

* funding: the NIH funding for disease research in millions

* disease_type: the type disease (acute or chronic)

### **Data Wrangling** 

  + We put all sub-datasets in long format and renamed variables as necessary. 
 
  + We restricted our final dataset to contain only non-solution drugs. The pricing units of these drugs are described as “each” or “per gram.” We omitted all solution-type drugs because the Drug Price dataset did not specify if liquid drugs were drinkable solutions or injectable.  Also all drugs were measured by two different units: milliliters and grams. Therefore, we could not compare between solution and per gram/each type of drugs. 
 
  + The Drug Price Excel dataset had over 5 million observations. Prices were recorded for each drug every week.  To representatively condense this dataset, we obtained a yearly average drug price (avg_price). This condensed the Drug Price dataset to approximately 2.5 million observations. 
 
  + We joined patents, products, exclusivity, ingredient, drug_disease_data, final_nih_funding, and drug_price and chronic_diseases_final into a final dataset (final_dataset). We used the variables ingredient, application_no, product_no, drug_type, trade_name, otc, and disease as keys for joining (inner and left).
  
* The code chunks below were used for loading and tidying the data.

```{r load_packages, warning = FALSE, message = FALSE}
library(tidyverse)
library(tidytext)

library(broom)
library(dplyr)
library(forcats)
library(httr)
library(janitor)
library(knitr)
library(plotly)
library(readxl)
library(rvest)
library(stringr)
library(viridis)
```

#### **Dataset 1: Drug Prices**

* Scrapping and Saving as CSV the Drug Price to speed up run-time.
```{r tidy_drug_price, warning = FALSE, message = FALSE}
# # API code
# url = "https://data.medicaid.gov/resource/tau9-gfwr.csv"
# drug_price =
#   GET(url, query = list("$limit" = 9999999)) %>%
#   content("parsed") %>%
#   clean_names()

# # CSV code
drug_price =
  read_csv("../data/drug_price.csv") %>%
  clean_names()
```

* The raw `drug_price` dataset is huge and takes a while to load.
* It contains weekly drug prices from November 2013 to October 2017 recorded. There are `r drug_price %>% nrow()` observations and `r drug_price %>% ncol()` variables in the dataset:
    + `as_of_date`: date of data posting
    + `classification_for_rate_setting`: indicates whether, for NADAC calculation, the NDC was considered brand (‘B’) or generic (‘G’) or brand (‘B’) approved under an Abbreviated New Drug Application (ANDA) (‘B-ANDA’).
    + `corresponding_generic_drug_effecitve_date`:  effective date of when the Corresponding Generic Drug NADAC Per Unit is assigned to a multiple source brand drug NDC
    + `corresponding_generic_drug_nadac_per_unit`: NADAC for the corresponding generic drug
    + `effective_date`: effective date of the NADAC Per Unit cost
    + `explanation_code`: codes that pertain to how the NADAC was calculated. see explanation code
descriptions [here](https://www.medicaid.gov/medicaid-chip-program-information/by-topics/prescription-drugs/ful-nadac-downloads/nadacdatadefinitions.pdf)
    + `nadac_per_unit`: National Average Drug Acquisition Cost per unit
    + `ndc`:  11-digit FDA code that includes the labeler code, product code, and package code
    + `ndc_description`: drug name, strength, and dosage form of the drug 
    + `otc`: over-the-counter (OTC) product (‘Y’ or ‘N’)
    + `pharmacy_type_indicator`: source of pharmacy survey data used to calculate the NADAC. ‘ C/I’ indicates data was collected from surveys of Chain/Independent pharmacies. Other pharmacy type indicators are not used at this time.
    + `pricing_unit`:  pricing unit for the associated NDC (‘ML’, ‘GM’ or ‘EA’)
* We will focus on the variables `effective_date`, `ndc`, `ndc_description`, `otc`, `classification_for_rate_setting`, `pricing_unit`, and `nadac_per_unit`. We will rename the variables `effective_date`, `ndc_description`, `classification_for_rate_setting`, and `nadac_per_unit` as `date`, `drug_name`, `drug_type`, and `unit_price` respectively. We will also split the `date` variable into the `year`, `month` and `date` variables.

* Cleaning Drug Price Dataset
```{r rename_split_date, warning = FALSE, message = FALSE}
drug_price = 
  drug_price %>%
  rename(trade_name = ndc_description,
         drug_type = classification_for_rate_setting,
         unit_price = nadac_per_unit) %>%
  mutate(trade_name = str_replace(trade_name, "[0-9]", "_"),
         trade_name = str_to_title(trade_name),
         otc = recode(otc, "Y" = "yes", "N" = "no"),
         otc = str_to_title(otc),
         otc = as.factor(otc)) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = "_") %>% 
  separate(effective_date, into = c("year", "month", "date")) %>%
  select(-c(date, x1, remove)) %>%
  mutate(trade_name = trimws(trade_name, which = c("both"))) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = " ") %>% 
  filter(is.na(remove)) %>%
  select(-remove) %>% 
  filter(pricing_unit == "GM" | pricing_unit == "EA") %>% 
  select(trade_name, everything()) 
```

```{r, warning = FALSE, message = FALSE}
new_drug_price = drug_price %>% 
  group_by(trade_name, drug_type, otc, pricing_unit, year) %>% 
  summarize(avg_price = mean(unit_price, na.rm = TRUE))

new_drug_price
```

#### **Dataset 2: Funding for Research**

* The NIH RCDC Report
* This dataset contains the annual support for various disease categories based on grants, contracts, and other funding mechanisms used across the National Institutes of Health (NIH).  Prevalence and mortality data included in this dataset is from the National Center for Health Statistics (NCHS) at the Centers for Disease Control & Prevention (CDC).
*Funding for 2018 are estimated figures.
```{r load_funding, warning = FALSE, message = FALSE}
url = "https://report.nih.gov/categorical_spending.aspx"
NIH_xml = read_html(url)
NIH_funding = (NIH_xml %>% html_nodes(css = "table"))[[3]] %>% html_table() %>% as_tibble()
NIH_funding = NIH_funding %>%
  clean_names() %>%
  mutate(US_mortality_2015 = x2015_us_mortality_19)

NIH_funding$x2015_us_prevalence_standard_error_19  = recode(NIH_funding$x2015_us_prevalence_standard_error_19 , "-" = "NA")
NIH_funding$US_mortality_2015 = recode(NIH_funding$US_mortality_2015, "-" = "NA")

NIH_funding = NIH_funding %>%
  separate(x2015_us_prevalence_standard_error_19, into = c("prevalence", "remove"), sep = "\\%") %>%
  select(-x2015_us_mortality_19, -remove)
NIH_funding$fy_2013actual = recode(NIH_funding$fy_2013actual, "+" = "NNA")
NIH_funding$fy_2014actual = recode(NIH_funding$fy_2014actual, "+" = "NNA")
NIH_funding$fy_2015actual = recode(NIH_funding$fy_2015actual, "+" = "NNA")
NIH_funding$fy_2016actual = recode(NIH_funding$fy_2016actual, "+" = "NNA")

NIH_funding = NIH_funding %>%
  mutate(fy_2013 = as.numeric(substring(fy_2013actual, 2))) %>%
  mutate(fy_2014 = as.numeric(substring(fy_2014actual, 2))) %>%
  mutate(fy_2015 = as.numeric(substring(fy_2015actual, 2))) %>%
  mutate(fy_2016 = as.numeric(substring(fy_2016actual, 2))) %>%
  mutate(fy_2017 = as.numeric(substring(fy_2017estimated_enacted, 2))) %>%
  mutate(fy_2018estimated = as.numeric(substring(fy_2018estimated, 2))) 

NIH_funding$prevalence = as.numeric(NIH_funding$prevalence)
NIH_funding$US_mortality_2015 = as.numeric(NIH_funding$US_mortality_2015)
  
NIH_funding = NIH_funding %>%
  select(-c(fy_2013actual, fy_2014actual, fy_2015actual, fy_2016actual, fy_2017estimated_enacted))

final_NIH_funding = NIH_funding %>%
  rename(disease = research_disease_areas_dollars_in_millions_and_rounded, 
         '2013' = fy_2013,
         '2014' = fy_2014,
         '2015' = fy_2015,
         '2016' = fy_2016,
         '2017' = fy_2017,
         '2018' = fy_2018estimated) %>%
  gather(key = "year", value = funding, c("2013", "2014", "2015", "2016", "2017", "2018")) %>% 
  mutate(disease = str_replace(disease, "[0-9]", "_"),
         disease = str_replace(disease, "\\-", ""),
         disease = str_replace(disease, "ALS", "Amyotrophic Lateral Sclerosis"),
         disease = str_replace(disease, "Sleep Research", "Sleep Disorders"),
         disease = str_replace(disease, "Smoking and Health", "Smoking Cessation")) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\_") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\(") %>% 
  select(-remove)

rm(NIH_funding)

final_NIH_funding
```

#### **Dataset 3: Patents**

* The Patents dataset from the FDA Orange Book
* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* New Drug Application Type: The type of new drug application approval, either New Drug Applications(NDA or innovator) or Abbreviated New Drug Applications(ANDA or generic)

* New Drug Application (NDA) Number (appl_no) : The FDA assigned number to the application. 

* Product Number: The FDA assigned number to identify the application products.  Each strength is a separate product.  May repeat for multiple part products. 

* Patent Number (patent_num): Patent numbers as submitted by the applicant holder for patents covered by the statutory provisions.  May repeat for multiple applications and multiple products. 

* Pediatric Exclusivity Granted: Yes or No.  Was pediatric exclusivity granted by the agency?

* Patent Expire Date: The date the patent expires as submitted by the applicant holder including applicable extensions.  This was split into Year, Month, and Day variables

* Drug Substance Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug substance flag indicating the sponsor submitted the patent as claiming the drug substance.   

* Drug Product Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug product flag indicating the sponsor submitted the patent as claiming the drug product.   

* Patent Use Code: Code to designate a use patent that covers the approved indication or use of a drug product.  May repeat for multiple applications, multiple products and multiple patents.

* Patent Delist Request Flag: Sponsor has requested patent be delisted.  This patent has remained listed because, under Section 505(j)(5)(D)(i) of the Act, a first applicant may retain eligibility for 180-day exclusivity based on a paragraph IV certification to this patent for a certain period.  Applicants under Section 505(b)(2) are not required to certify to patents where this flag is set to Y.

```{r load_patents, warning = FALSE, message = FALSE}
patents = read_csv("./data/patent.csv")
patents = patents %>% 
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "N" = "B")) %>%
  separate(patexp, into = c("month_pat_expires", "day_pat_expires", "year_pat_expires"), sep = "/") %>%
  separate(patent_no, into = c("patent_num", "pediatric_exclusivity_granted"), sep = "\\*")

patents$pediatric_exclusivity_granted[is.na(patents$pediatric_exclusivity_granted)] = "no"
patents$drugsub[is.na(patents$drugsub)] = "no"
patents$drugprod[is.na(patents$drugprod)] = "no"
patents$delist[is.na(patents$delist)] = "no"

patents = patents %>%
  mutate(pediatric_exclusivity_granted = factor(pediatric_exclusivity_granted, levels = c("no", "PED"), labels = c("No", "Yes"))) %>%
  mutate(drug_substance_flag = factor(drugsub, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(drug_prod_flag = factor(drugprod, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(patent_delisted = factor(delist, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  select(-drugsub, -drugprod, -patexpstr) %>%
  rename(pat_use_code = patuse)
patents
```

#### **Dataset 4: Products**

*The Products dataset from the FDA Orange Book

* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* Ingredient: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

* Dose form;The product dosage form

* Route:  Product dosage route 

* Trade_Name: The trade name of the product as shown on the labeling.

* Applicant: The firm name holding legal responsibility for the new drug application.  The firm name is condensed to a maximum twenty character unique string.

* Strength: The potency of the active ingredient.  May repeat for multiple part products.

* Drug Application Type: The type of new drug application approval. NDA or ANDA as for patents dataset.

* New Drug Application (NDA) Number: The FDA assigned number to the application.

* Product Number: The FDA assigned number to identify the application products. Each strength is a separate product.  May repeat for multiple part products.

* Therapeutic Equivalence (TE) Code: The TE Code indicates the therapeutic equivalence rating of generic to innovator Rx products.

* Approval Date: The date the product was approved as stated in the FDA approval letter to the applicant. Products approved prior to the January 1, 1982 contain the phrase: "Approved prior to Jan 1, 1982".  This separated into Year, Month, and Day variables.

* Reference Listed Drug (RLD) Updated: The RLD is a drug product approved under section 505(c) of the FD&C Act for which FDA has made a finding of safety and effectiveness. In the electronic Orange Book, an RLD is identified by “RLD” in the RLD column.

* Reference Standard (RS) New! :A “reference standard” is the drug product selected by FDA that an applicant seeking approval of an ANDA must use in conducting an in vivo bioequivalence study required for approval of an ANDA.  In the electronic Orange Book, a reference standard is identified by “RS” in the RS column.

*Type: The group or category of approved drugs. RX (prescription), OTC (over the counter), or DISCN (discontinued).

*Applicant Full Name: The full name of the firm holding legal responsibility for the new drug application. 

```{r load_products, warning = FALSE, message = FALSE}
products = read_csv("./data/products.csv")
products = products %>%
  rename(drug_type = appl_type,
         otc = type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B"),
         otc = recode(otc, "OTC" = "yes", "RX" = "no", "DISCN" = "no")) %>%
  separate(appdate, into = c("approval_month", "approval_day", "approval_year"), sep = "/") %>%
  #separate(doseform, into = c("form", "release_type"), sep = ",")
  mutate(otc = factor(otc)) %>%
  mutate(ref_listed_drug = factor(rld)) %>%
  mutate(ref_std = factor(rs)) %>%
  select(-appdatestr, -rld, -rs, -dfroute)
products
```

#### **Dataset 5: Exclusivity**

We load and tidy the `exclusivity` dataset

```{r tidy_exclusivity, warning = FALSE, message = FALSE}
exclusivity = read_csv("./data/exclusivity.csv") %>%
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B")) %>% 
  separate(excldate, into = c("month_excl_expires", "date_excl_expires", "year_excl_expires"))
exclusivity
```

The tidied `exclusivity` dataset has `r exclusivity %>% nrow` observations and `r exclusivity %>% ncol` variables:

* `year`, `month`, and `date` the exclusivity expires
* `appl_type`: type of new drug application approval. New Drug Applications (NDA or innovator) are "N". Abbreviated New Drug Applications (ANDA or generic) are “A”.
* `appl_no`: FDA assigned number to the application.  Format is nnnnnn.
* `product_no`: FDA assigned number to identify the application products. Each strength is a separate product. May repeat for multiple part products.  Format is nnn.
* `exclcode`: Code to designate exclusivity granted by the FDA to a drug product.  Format is nnnnnnnnnn.
* `excldatestr`: The date the exclusivity expires. Format is MMM DD, YYYY.

#### **Dataset 6: Ingredient**

We load the `ingredient` dataset. 

```{r tidy_ingredients, warning = FALSE, message = FALSE}
ingredient = read_csv("./data/ingredient.csv") %>%
  clean_names() %>%
  select(singnum, singredient, everything())
ingredient
```

The tidied `ingredient` dataset has `r ingredient %>% nrow` observations and `r ingredient %>% ncol` variables:

* `singnum`: The number assigned to the single ingredient for each product.
* `singredient`: each single ingredient in the product.
* `ingredient`: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

#### **Dataset 7: Drug by Condition**

Scraping data on drugs per condition from [this website](https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/A)

```{r scrape_drug_disease, warning = FALSE, message = FALSE}

urls = paste("https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/", toupper(letters), sep = "")

get_drug_disease = function(url) {
  
  disease_data = read_html(url) %>% 
  html_nodes(css = ".ToggleDrugCategory") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(disease = value)
  
  drug_data = read_html(url) %>% 
  html_nodes(css = ".CategoryListSection a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug = value)
  
  drug_disease_data = read_html(url) %>% 
  html_nodes(css = "#MainColumn a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug_disease = value)
  
  drug_disease_joined = left_join(drug_disease_data, drug_data, disease_data, by = "key") %>% 
  left_join(., disease_data, by = "key") %>%
  fill(disease) %>%
  select(-c(drug,drug_disease))
  
  toremove = drug_disease_joined %>% distinct(disease) %>% pull()
  
  drug_disease_joined = drug_disease_joined %>% 
  filter(!key %in% toremove) %>% 
  rename(drug = key) %>% 
  .[-c(1:29),]
  
  drug_disease_joined
}

drug_disease_data = map_df(urls, get_drug_disease) %>% 
  mutate(disease = str_to_title(disease),
         drug = str_to_title(drug)) %>% 
  rename(trade_name = drug) %>%
  mutate(trade_name = trimws(trade_name, which = c("both"))) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = " ") %>% 
  select(-remove)

drug_disease_data
```

The `drug_disease_data` contains `r drug_disease_data %>% nrow` observations and `r drug_disease_data %>%  ncol` variables:

* `drug`: the drug name
* `disease`: the disease name

#### **Dataset 8: Chronic Diseases**

```{r, warning = FALSE, message = FALSE}
#first dataset
chronic_diseases_1_html = read_html("https://www.medicalschemes.com/medical_schemes_pmb/chronic_disease_list.htm")
chronic_diseases_1 = chronic_diseases_1_html %>%
  html_nodes("td td td .maintext") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#second dataset
chronic_diseases_2_html = read_html("http://www.health24.com/Medical-schemes/PMB-and-chronic-disease/List-of-chronic-diseases-20120721")
chronic_diseases_2 = chronic_diseases_2_html %>%
  html_nodes("ul:nth-child(10) li , ul:nth-child(10) a") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#third dataset
chronic_diseases_3_html = read_html("https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Chronic-Conditions/CC_Main.html")
chronic_diseases_3 = chronic_diseases_3_html %>%
  html_nodes("td") %>%
  html_text() %>%
  as_tibble() %>%
  rename(disease = value)

#final chronic disease dataset
chronic_diseases = rbind(chronic_diseases_1, chronic_diseases_2, chronic_diseases_3) %>%
  distinct()

#recode diseases
chronic_diseases$disease[62] = "Cancer"
chronic_diseases$disease[67] = "High Blood Pressure"
chronic_diseases$disease[43] = "High cholesterol"
chronic_diseases$disease[60] = "Austism"
chronic_diseases$disease[55] = "Arthritis"
chronic_diseases$disease[46] = "Hypothyroidism"
chronic_diseases$disease[38] = "Dysrhythmia"
chronic_diseases$disease[66] = "inactive thyroid gland"
chronic_diseases$disease[53] = "alzheimer's disease"
chronic_diseases$disease[26] = "Dementia"
chronic_diseases$disease[56] = "Hepatitis"
chronic_diseases$disease[71] = "COPD"
```

#### Join Datasets

```{r join_dataset, warning = FALSE, message = FALSE}
#A: join datasets by ingredient for ingredient and products (left join)
#products = longer dataset + ingredient
product_ingredient = left_join(products, ingredient, by = "ingredient")
product_ingredient

#B: exclusivity and patents left join (more~less)
patent_exclusivity = left_join(patents, exclusivity, by = c("appl_no", "product_no", "drug_type"))
patent_exclusivity

#C: join A and B left join: "Orange Book." Thursday: meet to eliminate variables (inner join: only commonalities are preserved) #eliminate drugs that do not match
orange_book = left_join(product_ingredient, patent_exclusivity, by = c("appl_no", "product_no", "drug_type"))

orange_book = orange_book %>%
  mutate(ingredient = str_to_title(ingredient),
         doseform = str_to_title(doseform),
         route = str_to_title(route),
         trade_name = str_to_title(trade_name),
         applicant = str_to_title(applicant),
         otc = str_to_title(otc),
         appfull = str_to_title(appfull),
         singredient = str_to_title(singredient),
         strength = str_to_title(strength))
orange_book

# final goal: disease, funding, drug prices, and Orange Book

# eliminate unnecessary variables from orange book dataset
orange_book_clean = orange_book %>%
  rename(application_no = appl_no, 
         active_ingredient = singredient, 
         dose_form = doseform) %>%
  select(-c(ingredient, applicant, product_no, tecodestr, tecode, approval_day, ref_std, singnum, day_pat_expires, pat_use_code, drug_substance_flag, drug_prod_flag, exclcode, excldatestr, date_excl_expires)) %>% 
  select(trade_name, everything()) %>% 
  separate(dose_form, into = c("dose_form", "remove")) %>%
  filter(is.na(remove)) %>% 
  select(-remove) %>% 
  filter(str_detect(dose_form, regex("Tablet", ignore_case = TRUE))) %>%
  mutate(trade_name = trimws(trade_name, which = c("both")),
         trade_name = str_replace_all(trade_name, ", ", "-"),
         trade_name = str_replace_all(trade_name, " And ", "-"))

# inner join of disease drug and orange book by trade_name
final_dataset =
  new_drug_price %>%
  inner_join(., orange_book_clean, by = c("trade_name", "drug_type", "otc")) %>% 
  distinct() %>% 
  left_join(., drug_disease_data, by = "trade_name") %>% 
  distinct() %>% 
  mutate(disease = str_replace(disease, " And ", "_"),
         disease = str_replace(disease, "High Blood Pressure \\(", ""),
         disease = str_replace(disease, "Copd \\(", ""),
         disease = str_replace(disease, "\\/Hyperactivity", ""),
         disease = str_replace(disease, "\\)", ""),
         disease = str_replace(disease, " Mellitus, Type 2", ""),
         disease = str_replace(disease, " Mellitus Types I", ""),
         disease = str_replace(disease, "Hepatitis", "Hepatitis C"),
         disease = str_replace(disease, "Hepatitis C B", "Hepatitis B"),
         disease = str_replace(disease, "Hepatitis C C", "Hepatitis C"),
         disease = str_replace(disease, "Hiv/Aids", "HIV/AIDS"),
         disease = str_replace(disease, " \\- ", "_"),
         disease = str_replace(disease, "Migraine", "Migraines")
         ) %>%
  separate(disease, into = c("disease", "remove"), sep = "\\_") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\(") %>% 
  select(-remove) %>% 
  separate(disease, into = c("disease", "remove"), sep = "\\;") %>%
  select(-remove) %>% 
  left_join(., final_NIH_funding, by = c("disease", "year")) %>%
  as_tibble() %>%
  distinct() %>% 
  mutate(disease = str_replace(disease, "Chronic Obstructive Pulmonary Disease", "Chronic Obstructive Pulmonary Disorder"),
         disease = str_replace(disease, "Kidney Disease", "Chronic Kidney Disease"),
         disease = str_replace(disease, "Cardiac Ischemia", "Coronary Artery Disease"),
         disease = str_replace(disease, "Diabetes", "Diabetes Mellitus Types 1 & 2"),
         disease = str_replace(disease, "Bipolar Disorder", "Bipolar Mood Disorder"))

#joining for chronic
#need to include breast cancer, hepatitis b, hepatitis c, lung cancer, prostate cancer bc chronic disease set does not specify
#hepatitis
hepatitis_chronic = final_dataset %>%
  filter(str_detect(disease, regex("hepatitis", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#cancer
cancer_chronic = final_dataset %>%
  filter(str_detect(disease, regex("cancer", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#hiv/aids
hiv_aids_chronic = final_dataset %>%
  filter(str_detect(disease, regex("hiv", ignore_case = TRUE)) | str_detect(disease, regex("aids", ignore_case = TRUE))) %>%
  pull(disease) %>%
  unique() %>%
  as_tibble() %>%
  rename(disease = value)

#combine hepatitis, cancer and hiv/aids with chronic diseases
chronic_diseases = rbind(chronic_diseases, hepatitis_chronic, cancer_chronic, hiv_aids_chronic)
chronic_diseases = chronic_diseases %>%
  unique()

#indicator of chronic disease
indicator_chronic_disease = vector()
indicator_chronic_disease[1:nrow(chronic_diseases)] = c("yes")
indicator_chronic_disease = as.tibble(indicator_chronic_disease)

#final chronic disease dataset with indicator column (y/n)
chronic_diseases_final = cbind(chronic_diseases, indicator_chronic_disease) %>%
  rename(chronic_disease = value) 
#formatting for exact matching
final_dataset$disease = trimws(final_dataset$disease, which = "right")
chronic_diseases_final$disease = trimws(chronic_diseases_final$disease, which = "both")
final_dataset$disease = tolower(final_dataset$disease)
chronic_diseases_final$disease = tolower(chronic_diseases_final$disease)

# Join final dataset and chronic disease dataset to complete analysis.
final_dataset = left_join(final_dataset,chronic_diseases_final, by = "disease")
final_dataset$chronic_disease[is.na(final_dataset$chronic_disease)] = "no"
final_dataset = final_dataset %>%
  mutate(disease_type = as.factor(recode(chronic_disease, 'no' = "acute", 'yes' = "chronic")),
         disease = str_to_title(disease))

rm(chronic_diseases, indicator_chronic_disease, cancer_chronic, hepatitis_chronic, hiv_aids_chronic, chronic_diseases_1, chronic_diseases_2, chronic_diseases_3, chronic_diseases_1_html, chronic_diseases_2_html, chronic_diseases_3_html, chronic_diseases_final, patent_exclusivity, product_ingredient) #clean up workspace
```


### **Analysis & Discussion**

First, we looked to see if there was an overall trend in the average price of all drugs from 2013 to 2017.  We observe a clear increasing trend in the overall average drug price.  In particular, we observe a notable increase between 2014 and 2015. We think this may be related to the full implementation of the Affordable Care Act (ACA) in 2015.

```{r, warning = FALSE, message = FALSE}

final_dataset %>%
  group_by(year) %>%
  summarize(avg_all_drugs_price = mean(avg_price)) %>%
  plot_ly(x = ~ year, y = ~avg_all_drugs_price, mode = "lines", type = "scatter") %>%
  layout(title = "Trend in Overall Average Drug Price", yaxis = list(title = "drug price (USD)"))
```

We also looked at the total NIH funding for each year from 2013-2018.  We see that funding increased until it leveled off in 2016 and there is a projected decrease for 2018.

```{r, warning = FALSE, message = FALSE}
final_NIH_funding %>%
  group_by(year) %>%
  summarize(total_funding = sum(funding, na.rm = TRUE)) %>%
  plot_ly(x = ~ year, y = ~ total_funding, mode = "lines", type = "scatter") %>% 
  layout(title = "Change in Total NIH Funding (millions USD) over Time")

```


Then, we looked to determine whether funding correlated with drug prices.  This does not really seem to be the case from the scatterplot.  Along the entire range of funding amounts, most drugs still have relatively low prices.  It is interesting that different drugs that treat the same disease seem to be largely clustered together.

We can see one breast cancer drug, Afinitor, which actually can be used to treat various types of cancers including kidney, pancreas, breast, and brain cancer, has an unusually high price.  We think these other applications are what are influencing the price.  Another unusual drug is Belviq, used to treat obesity.  

This drug has a very low price, which we think is because of the extremely high prevalence of obesity or other factors such as competitors. 

```{r, warning = FALSE, message = FALSE}
#does funding correlate with drug prices?

final_dataset %>%
  group_by(disease, trade_name) %>%
  summarize(avg_funding = mean(funding, na.rm = TRUE), 
            avg_price_disease = mean(avg_price, na.rm = TRUE)) %>%
  plot_ly(x = ~ avg_funding, y = ~ avg_price_disease, type = "scatter", color = ~disease, text = ~paste('Drug: ', trade_name, '<br> Disease:', disease)) %>%
  layout(title = "Average Funding vs Average Price", showlegend = FALSE)
```

Looking at funding vs. disease for acute vs chronic diseases, we see a relatively random scatter. Therefore, we do not think there is a significant trend for funding by disease type.

```{r, warning = FALSE, message = FALSE}  
ax <- list(
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = FALSE,
  showgrid = FALSE
)

final_dataset %>%
  group_by(disease, funding, disease_type) %>%
  summarize(avg_funding = mean(funding, na.rm = TRUE)) %>%
  plot_ly(x = ~ disease, y = ~ funding, color = ~disease_type, type = "scatter") %>%
  layout(title = "Average NIH Funding (millions USD) For Chronic vs Acute Diseases", xaxis = ax)
              
```


* We look at the yearly distribution of drug prices for a few drugs. Some drugs have skewed price distributions. Zoloft, a drug that treats panic disorders, seems to have almost doubled in price from 2013 to 2017.

```{r drug_price_distr, warning = FALSE, message = FALSE}
trade_name_choice = "Zoloft"
violin_drug = drug_price %>%
  filter(trade_name == trade_name_choice) %>%
  ggplot(aes(x = year, y = unit_price, fill = year)) + 
  geom_violin() +
  ggtitle(paste0("Distribution of Prices (USD) for ", trade_name_choice), subtitle = NULL)

ggplotly(violin_drug)
```

We created a spaghetti plot of the average price per year for each drug. Information about the disease that the drugs treat can be seen by hovering over the plot. We notice that, the drugs for Hepatitis C seem to have the highest cost.

```{r price_drug_disease, warning = FALSE, message = FALSE}
final_dataset %>% 
  #filter(disease %in% c("Obesity")) %>%
  filter(pricing_unit == "EA" & !is.na(disease)) %>% 
  plot_ly(x = ~year, y = ~avg_price, type = "scatter", mode = "lines", text = ~paste("Drug: ", trade_name, '<br>Disease:', disease), color = ~trade_name, alpha = 0.5) %>% 
  layout(title = "Average Price (USD) of Drugs over Time", showlegend = FALSE)
```

We also created a scatter plot of the mean NIH funding per drug (assumed to be the same as the NIH funding for disease research) against the demand of the drug (defined as the 2015 disease prevalence). Obesity seems to have received the most funding on average and to have the highest 2015 prevalence.  This may be due to Michelle Obama's Let's Move initiative to fight childhood obesity.

We looked to explore whether there was a relationship between prevalence and funding.  While the number of diseases with the required complete data was relatively small, it appears from the scatterplot that when you have a low prevalence, there is a wide range of average funding.  As the prevalence increases the funding amount generally seems to be on the lower side.  However, if you look more closely at which diseases are included, some interesting observations can be made. 

Many of the diseases with high funding are cancers, which have a low prevalence.  Most cancers have large subgroups with no good treatment options, so it makes sense that there is a lot of research focused on cancer and new drug development.  Some diseases with higher prevalence but lower funding are hypertension, migraines, ADD, and COPD, which do already have treatment options available on the market.

```{r funding_demand, warning = FALSE, message = FALSE}
final_dataset %>% 
  filter(pricing_unit == "EA" & !is.na(funding) & !is.na(prevalence)) %>% 
  group_by(trade_name, disease, prevalence) %>% 
  summarize(mean_fund = mean(funding)) %>% 
  plot_ly(x = ~prevalence, y = ~mean_fund, type = "scatter", alpha = 1, text = ~paste("Drug: ", trade_name, '<br>Disease:', disease), color = ~disease) %>%
  layout(title = "Funding (millions USD) vs Prevalence", showlegend = FALSE)
```

#### **Pharmaceutical Companies and Top Drugs**
```{r, warning = FALSE, message = FALSE}
# write_csv(final_dataset, path = "./data/final_dataset_20171205.csv")
final_dataset = read_csv("./data/final_dataset_20171205.csv")

#more cleaning
patents = final_dataset %>%
  ungroup() %>% 
  select(appfull, patent_num, year_pat_expires, disease) %>% 
  filter(!duplicated(patent_num)) %>%
  filter(!is.na(disease)) %>%
  filter(year_pat_expires > 2017) %>% 
  mutate(
    year_pat_expires = as.factor(year_pat_expires), 
    #appfull = str_replace(appfull, "-", " "),
    appfull = str_replace(appfull, " Ab", ""),
    appfull = str_replace(appfull, " And", ""),
    appfull = str_replace(appfull, " Biotech", ""),
    appfull = str_replace(appfull, " Co", ""),
    appfull = str_replace(appfull, " Inc", ""),
    appfull = str_replace(appfull, " International", ""),
    appfull = str_replace(appfull, " Ireland s", ""),
    appfull = str_replace(appfull, " Ltd", ""),
    appfull = str_replace(appfull, " Llc", ""),
    appfull = str_replace(appfull, " Lp", ""),
    appfull = str_replace(appfull, " Holdings", ""),
    appfull = str_replace(appfull, " Pharmaceutical", ""),
    appfull = str_replace(appfull, " Pharmaceuticals", ""),
    appfull = str_replace(appfull, " Products", ""),
    appfull = str_replace(appfull, " Research Institute", ""),
    appfull = str_replace(appfull, " Research Development", ""),
    appfull = str_replace(appfull, " s ", ""),
    appfull = str_replace(appfull, " Trading", ""),
    appfull = str_replace(appfull, " Unltd", ""),
    appfull = str_replace(appfull, "Allergans", "Allergan"),
    appfull = str_replace(appfull, "Astrazenecas", "Astrazeneca"),
    appfull = str_replace(appfull, "Bristol-Myers Squibb", "Bristol Myers Squibb"),
    appfull = str_replace(appfull, "Bristol-Myers Squibb Co", "Bristol Myers Squibb Co"),
    appfull = str_replace(appfull, "Janssens", "Janssen"),
    appfull = str_replace(appfull, "Ingelheims", "Ingelheim"),
    appfull = str_replace(appfull, "Pfizers", "Pfizer"),
    appfull = str_replace(appfull, "Wyeths Wholly Owned Sub Pfizer Inc", "Pfizer")) %>%
  arrange(appfull)
patents
```


```{r, warning = FALSE, message = FALSE}
#diseases currently with most patents
xax <- list(
  title = "Pharmaceutical Company",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = FALSE,
  showgrid = FALSE
)
yax = list(
  title = "No. of Patents",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)

#pharmaco's currently holding the most patents
most_pat_company = patents %>%
  group_by(appfull) %>%
  count() %>%
  rename(num_pat_held = n) %>%
  ungroup() %>%
  mutate(appfull = fct_reorder(appfull, num_pat_held)) %>%
  plot_ly(x = ~appfull, y = ~num_pat_held, color = ~appfull, type = "bar", colors = "Set2") %>% 
  layout(title = "No. of Patents Currently Held by Pharmaceutical Company", xaxis = xax, yaxis = yax, showlegend = FALSE)
most_pat_company

most_pat_dis = patents %>%
  group_by(disease) %>%
  count() %>%
  rename(num_pat_held = n) %>%
  ungroup() %>%
  mutate(disease = fct_reorder(disease, num_pat_held)) %>%
  plot_ly(x = ~disease, y = ~num_pat_held, color = ~disease, type = "bar", colors = "Set2") %>% 
  layout(title = "No. of Patents Currently Held by Disease", xaxis = xax, yaxis = yax, showlegened = FALSE)
most_pat_dis
```


```{r, warning = FALSE, message = FALSE}
#pharmaco that has most patents expiring by year (i.e. in each upcoming year, who has most expiring?)
pat_exp = patents %>%
  group_by(appfull, disease, year_pat_expires) %>%
  count() %>% 
  rename(num_pat_exp = n) 
# ay vs day vs ady
# 203 vs 233 vs 233

xax_2 = list(
  title = "Year",
  zeroline = TRUE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)

yax_2 = list(
  title = "No. Patents Expiring",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)
  
pat_exp %>% 
  plot_ly(
    x = ~year_pat_expires, 
    y= ~num_pat_exp,
    type = "scatter", 
    mode = 'markers', 
    marker = list(size = ~num_pat_exp*3), 
    text = ~paste('Company: ', appfull, '<br> Disease:', disease)) %>% 
  layout(title = "Projection of Expiring Patents", xaxis = xax_2, yaxis = yax_2, showlegend = FALSE)

xax_2 = list(
  title = "Year",
  zeroline = TRUE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)

yax_2 = list(
  title = "Company",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)


#BUBBLE
pat_exp %>%
  plot_ly(x = ~year_pat_expires, 
          y = ~appfull, 
          color = ~appfull, 
          type = "scatter", 
          mode = 'markers', 
          marker = list(size = ~num_pat_exp*3), 
          text = ~paste('Count: ', num_pat_exp)) %>%
  layout(title = "Projection of Expiring Patents by Pharmaceutical Company ", xaxis = xax_2, yaxis = yax_2, showlegend = FALSE)

xax_3 = list(
  title = "Year",
  zeroline = TRUE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)
yax_3 = list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = TRUE,
  showgrid = TRUE
)

#BUBBLE_disease
patents %>%
  group_by(disease, appfull, year_pat_expires) %>%
  count() %>%
  rename(num_pat_exp = n) %>%
  # ungroup() %>%
  # mutate(disease = fct_reorder(disease, num_pat_exp)) %>%
    plot_ly(x = ~year_pat_expires, 
          y = ~disease, 
          color = ~appfull, 
          type = "scatter", 
          mode = 'markers', 
          marker = list(size = ~num_pat_exp*3), 
          text = ~paste('Count: ', num_pat_exp)) %>%
  layout(title = "Projection of Expiring Patents by Disease", xaxis = xax_2, yaxis = yax_2, showlegend = FALSE)

```

#### **Disease & Funding**

* Does funding differ by disease? 

  + There are 27 unique diseases in our dataset. Obesity has the highest mean funding of $906.2 million a year. Breast cancer has the second highest mean funding of $675.98 million per year. Alzheimer's Disease has the third highest mean funding of $646 million per year. Paget's Disease, a disease that disrupts the replacement of old bone tissue with new bone tissue, received the lowest mean funding of $1 million per year. Other diseases that received the lowest mean funding are Psoriasis ($16.7 million/year) and Migraines ($19.2 million/year). Obesity, Paget's Disease, Psoriasis and Migraines are acute conditions, while Breast cancer and Alzheimer's Disease are chronic conditions. 

```{r Disease & Funding, warning = FALSE, message = FALSE}
# final_dataset = read.csv("./data/final_dataset.csv")
#shiny application: funding by disease
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  mutate(disease = factor(disease)) %>%
  group_by(disease) %>%
  summarize(mean_funding = mean(funding)) %>%
  mutate(disease = fct_reorder(disease, mean_funding)) %>%
  plot_ly(x = ~disease, y = ~mean_funding, color = ~disease, type = "bar", colors = "Set3") %>% 
  layout(title = "NIH Funding per Disease (millions USD)", xaxis = ax)

#funding by disease (filtered by disease type = acute)
#shiny: user clicks acute and sees funding
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "acute") %>%
  mutate(disease = factor(disease)) %>%
  group_by(disease) %>%
  summarize(mean_funding = mean(funding)) %>%
  mutate(disease = fct_reorder(disease, mean_funding)) %>%
  plot_ly(x = ~disease, y = ~mean_funding, color = ~disease, type = "bar", colors = "Set3")

#funding by disease (filtered by disease type = chronic)
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding) & disease_type == "chronic") %>%
  mutate(disease = factor(disease)) %>%
  group_by(disease) %>%
  summarize(mean_funding = mean(funding)) %>%
  mutate(disease = fct_reorder(disease, mean_funding)) %>%
  plot_ly(x = ~disease, y = ~mean_funding, color = ~disease, type = "bar", colors = "Set3")
```

#### **Acute vs. Chronic Disease**
##### Funding

  + Based on the boxplots below, we see that acute conditions have a wider interquartile range compared to chronic conditions: there is greater variability in acute condition funding compared to chronic. 25% of acute conditions have a funding of $18 million or less. 25% of acute conditions receive funding of more than $313 million or more. The median funding for acute conditions is $50 million per year. Acute funding is right skewed. 
  
  + Comparatively, chronic conditions have a lower variability in funding, but have more outliers. 25% of chronic conditions have a funding of $224 million or less. 25% of chronic conditions receive funding of more than $272.5 million or more. The median funding for chronic conditions is $253 million per year. Chronic funding has an approximately normal distribution in funding.
  

```{r Acute vs. Chronic, warning = FALSE, message = FALSE}
#acute vs. chronic (boxplot)
#Funding by disease status
final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  mutate(disease_type = fct_reorder(disease_type, funding)) %>%
  group_by(disease_type) %>% 
  plot_ly(y = ~funding, type = "box", color = ~disease_type, colors = "Set3") %>% 
  layout(title = "Distribtuion NIH Funding (millions USD) for Acute vs Chronic Diseases")
```

  + The mean of funding for chronic diseases of $323.68 million/year is statistically different from the mean of acute funding of $184.51 million/year. Assuming that the two samples are normally distributed, independent and have equal variances, we performed a two-sample t-test for Independent Samples. At the 0.05 significance level, we reject the null hypothesis that the true difference of mean funding between disease types is zero. We are 95% confident that chronic diseases receive between $125 million to $153 million more dollars in mean funding per year compared to acute diseases.
  
```{r, warning = FALSE, message = FALSE}
#Statistical Test of Funding Difference
acute = final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  filter(disease_type == "acute") 
chronic = final_dataset %>%
  filter(!is.na(disease) & !is.na(funding)) %>%
  filter(disease_type == "chronic")
t_test_results = t.test(acute$funding, chronic$funding, var.equal = TRUE, paired = FALSE)
t_test_results
```

##### Pricing

  + Acute conditions have greater variability in pricing compared to chronic diseases, while chronic diseases have more outliers in pricing. Acute has a larger IQR for pricing, while chronic has a wider range in pricing. The average price of drugs that treat chronic diseases ranges from $0.03 to $1,096.67. The average price of drugs that threat chronic diseases ranges from $0.11 to $462.03. 
 
    + Drugs that treat acute conditions have a mean "average price" of $173.43 per dose and chronic diseases have a mean "average price" of $125.39 per dose. Assuming that the two samples are normally distributed, independent and have equal variances, we performed a two-sample t-test for Independent Samples. At the 0.05 significance level, we reject the null hypothesis that the true difference of mean "average price" between drugs that treat acute or chronic diseases is zero. We are 95% confident that drugs that treat acute conditions are priced between $43.87 and $52.22 more per dose than drugs that treat chronic conditions. 
    
```{r, warning = FALSE, message = FALSE}
#Pricing by disease status (boxplot)
final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  mutate(disease_type = fct_reorder(disease_type, avg_price)) %>%
  group_by(disease_type) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~disease_type, colors = "Set3")

acute = final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  filter(disease_type == "acute") 
chronic = final_dataset %>%
  filter(!is.na(disease) & !is.na(avg_price)) %>%
  filter(disease_type == "chronic")
t_test_results = t.test(acute$avg_price, chronic$avg_price, var.equal = TRUE, paired = FALSE)
t_test_results
```

### **Case Study** 
* We are interested in conducting a case study on pharmaceutical drugs that receive the highest advertisement spending, are the most prescribed according to US sales, are most abused (over prescribed, highly addictive, and/or frequently used as illicit street drugs), and are commonly referenced in everyday life or in popular American culture.

##### Most Advertised (by spending)

```{r Most Advertised, warning = FALSE, message = FALSE}
top_advertising_cost = c("Humira", "Lyrica", "Eliquis", "Xeljanz", "Cialis", "Invokana", "Breo", "Latuda", "Victoza", "Viagra")
top_advertising_cost
```

  + First we examined the most advertised drugs in 2016 (top twenty).
  
    + In 2016, Humira had the highest advertising spending of $344 million.
  
    + Xeljanz, which treats both arthritis and rheumatoid arthritis (chronic conditions), had the highest mean average price per dose of $45.70. 
  
    + Eliquis, which treats atrial fibrillation, stroke, and thromboembolism (both chronic and acute conditions), had the lowest mean yearly price per dose of $5.29.
    
      + Of the twenty drugs with highest advertising spending, six drugs were found within the final dataset.
  
##### Most Prescribed (by sales)

```{r Most Prescribed, warning = FALSE, message = FALSE}
### Top 20 precribed drugs by US sales
top_prescribed_drugs_sales = c("Humira", "Harvoni", "Enbrel", "Lantus Solostar", "Remicade", "Januvia", "Advair Diskus", "Lyrica", "Crestor", "Neulasta", "Copaxone", "Rituxan", "Tecfidera", "Xarelto", "Lantus", "Eliquis", "Truvada", "Vyvanse", "Avastin", "Symbicort")
top_prescribed_drugs_sales
```

  + Second, we examined the most prescribed drugs as defined by US sales. 
  
      + Humira was the most prescribed drug for 2016, according to US sales. Americans bought $13.6 billion dollars of Humira, a biologic which treats adults with Rheumatoid Arthritis (RA) and moderate to severe Crohn's Disease.
      
      + Harvoni was the second most prescribed drug for 2016, according to US sales. Americans bought $10 billion dollars of Harvoni, a antiviral medication that treats adults with Hepatitis C.
      
      + Enbrel was the third most prescribed drug for 2016, according to US sales. Americans bought $3.6 billion dollars of Enbrel, a antiviral medication that treats adults with Hepatitis C.

##### Most Abused

```{r Most Abused, warning = FALSE, message = FALSE}
most_abused_drugs = c("Vicodin", "OxyContin", "Ritalin", "Concerta", "Focalin", "Metadate", "Ambien", "Lunesta", "Valium", "Xanax", "Duragesic", "Opana", "Darvon", "Dilaudid", "Demerol", "Lomotil", "Nembutal", "Dexedrine", "Adderall", "Percocet", "Suboxone", "Fentanyl") 
#Interested in seeing how prescription opioid prices have increased through time (Muhire's plot) 
most_abused_drugs
```
  + Now, let's take a look at the most abused drugs in America
  
    + This list of drugs involves drugs that are over prescribed, highly addictive, and/or frequently used as illicit street drugs
    
      + Benzodiazepines
    
      + Central nervous system depressants
    
         + Nembutal
      
          + Valium: used to treat anxiety disorders, abused along with alcohol or other depressants
      
          + Xanax: frequently referenced in "trap music"
      
         + Suboxone: a popular street drug, most popular illicit drug bought and sold in jails and prisons--often smuggled
    
      + Stimulants
    
        + Dexedrine
      
        + Ritalin: commonly abused by college students
      
        + Concerta
      
        + Adderall: commonly abused by college students
  
  + Opioids
    
       + Duragesic
      
          + Fentanyl is Heroin's synthetic cousin. Synthetic Fentanyl (combined with heroin) is more addictive and deadlier than heroin. According to the CDC, 100 times more potent than morphine. Synthetic Fentanyl is a popular street drug driving heroin overdose deaths in the US.
        
      + Vicodin
      
      + OxyContin
      
      + Opana
      
      + Darvon
      
      + Dilaudid
      
      + Demerol 
      
      + Lomotil
      
      + Percocet: crushed into power and snorted (like cocaine) for a high. commonly referenced in trap music
      
    + Important Facts & Figures about Opioid Epidemic
  
      + Public Health threat. 
    
      + 2 million Americans abused or dependent, 1000+ ER visits daily. 78 deaths daily. (2014)
      
      + Causes of Epidemic: Practitioners were urged to treat pain aggressively (without the tools and training), pharmaceutical companies marketing prescription opioids to doctors.
      
      + 259 million opioid prescriptions in 2012, according to the CDC. An increase in 400% since 1999.
      + Prescription opioids account for 1/2 of opioid deaths. Considered gateway drugs for heroin
      
      + Four in five Heroin Users used prescription opioids before heroin.
      
      + Highly addictive. Other opioids include morphine, codeine cough syrup (know as "lean", "purple drank", "Sizzurp", and "syrup".
      
  + Something to think about
  
    + The pop legends Michael Jackson, Whitney Houston and Prince each died with with opioids (painkillers) and/or benzodiazepines (anti anxiety) in their systems. 
    
    + "The gods of pop music, indestructible in song, died taking the same drugs that everyone takes." Chris Richards of The Washington Post
      
  + References
  
    + https://www.drugabuse.gov/drugs-abuse/prescription-drugs-cold-medicines
    
    + https://www.marylandaddictionrecovery.com/top-10-most-abused-prescription-drugs
    
    + https://newlifehouse.com/top-10-commonly-abused-prescription-medications/
    
    + https://www.cbsnews.com/news/mixing-opioids-oxycodone-and-popular-sedatives-xanax-may-be-deadly/
    + https://www.washingtonpost.com/lifestyle/style/soft-smooth-and-steady-how-xanax-turned-american-music-into-pill-pop/2017/04/19/535a44de-1955-11e7-bcc2-7d1a0973e7b2_story.html?utm_term
    
##### Anecdotal or Commonly Discussed in Popular Culture

```{r Popular Culture, warning = FALSE, message = FALSE}
most_popular_drugs = c("Viagra", "Lipitor", "Xanax", "Celebrex", "Prozac", "Crestor", "Nexium", "Lisinopril", "Zoloft", "Abilify", "Prilosec", "Percocet", "Vicodin", "Zocor")
most_popular_drugs
```
  + Finally, we investigate "popular" drugs: pharmaceutical drugs that people we know use, ones that we see commercials for, and/or commonly discussed in popular culture
  
  + The main protagonist on House, M.D. was addicted to Vicodin. FDA is considering banning the drug. 400 people overdose and die each year. People take it as a strong Tylenol or pain-killer.
  + Zocor (simvastatin): cholesterol lowering drug

  + Relationship between "pill-pop" and American music
  
    + https://www.washingtonpost.com/lifestyle/style/soft-smooth-and-steady-how-xanax-turned-american-music-into-pill-pop/2017/04/19/535a44de-1955-11e7-bcc2-7d1a0973e7b2_story.html
    
  + Reference: https://www.forbes.com/2010/05/11/narcotic-painkiller-vicodin-business-healthcare-popular-drugs.html#212b328b787f

##### Comparing Mean Average Price per Tablet for each Drug Group
  + We compared pricing of the drugs classified in each category.
  
  + The Most Abused Drugs had the lowest mean of average price per tablet of $5.22.
  
  + The Most Advertised and the Most Popular Drugs have similar means of average price per tablet of $25.78 and $22.86, respectively. 
  
  + The Most Prescribed Drugs have the highest mean of average price per tablet of $259.26. 
  
  + These results are particularly interesting. 
  
      + The most abused drugs are relatively inexpensive compared to others. This gives patients greater access to highly addictive prescriptions, including painkillers. This may be a driving force of prescription drug abuse; cheap and highly addictive are fatal combinations for drug dependence.
      
      + The most prescribed drugs are notably more expensive. The mean is skewed by the Hepatitis C drug, Harvoni. Harvoni has a median average price of $1,093.83. Excluding Harvoni results in a mean of average price per tablet of $21.71 for most prescribed drugs, which is on-par with most popular and most advertised drugs. 
      
```{r, warning = FALSE, message = FALSE}
mean_price_abused = final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% most_abused_drugs) %>%
  summarize(mean_price = mean(avg_price))
#mean average price of per tablet of most abused drugs is $5.22

mean_price_popular = final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% most_popular_drugs) %>%
  summarize(mean_price = mean(avg_price))
#mean average price of per tablet of most abused drugs is $22.86

mean_price_prescribed = final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% top_prescribed_drugs_sales) %>%
  filter(trade_name != "Harvoni") %>%
  summarize(mean_price = mean(avg_price))
#mean average price of per tablet of most abused drugs is $259.26
#mean average price of per tablet of most abused drugs is $21.71 when excluding Harvoni, an extreme outlier. 

mean_price_advertised = final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% top_advertising_cost) %>%
  summarize(mean_price = mean(avg_price))
#mean average price of per tablet of most abused drugs is $25.78
```

##### Boxplots of each category of drugs

```{r Plottly Formatting, warning = FALSE, message = FALSE}
#plotly formatting
f = list(
  family = "Courier New, monospace",
  size = 18,
  color = "#7f7f7f"
)
trade_name_axis = list(
  title = "Trade Name",
  titlefont = f
)
avg_price_axis = list(
  title = "Average Drug Price",
  titlefont = f
)
```

##### The Distribution of Average Price for Most Advertised Drugs, Ordered by Descending Advertising Spending

  + Elliquis had the highest advertising spending of $174 million, yet had the lowest median of average drug price of $5.28. 
  
  + Xeljanz had the highest median of average drug price of $43.14, among this group. Also, Xeljanz had the most variability in this group.
  
```{r Most Advertised plots, warning = FALSE, message = FALSE}
#shiny application : most advertised (by spending) vs. most abused vs. most prescribed (by sales)
#another shiny application: give list of all "most" drugs and can see boxplot for that specific drug
final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% top_advertising_cost) %>%
  ungroup() %>%
  mutate(trade_name = factor(trade_name)) %>%
  mutate(trade_name_new = fct_relevel(trade_name, c("Eliquis", "Xeljanz", "Cialis", "Invokana", "Latuda","Viagra"))) %>%
   group_by(trade_name) %>% 
  plot_ly(x = ~trade_name_new, y = ~avg_price, type = "box", color = ~trade_name, colors = "Set3") %>%
  layout(title = "Distribution of Average Price for Most Advertised Drugs, 
         Ordered by Descending Advertising Spending", xaxis = trade_name_axis, yaxis = avg_price_axis)
```

##### The Distribution of Average Price for Most Popular Drugs

  + Viagra, which treats erectile dysfunction (acute), had the highest median of average price of $35.47. 
  
  + Xanax, which treats anxiety and panic attack (acute), had the lowest median of average price of $3.41.
  
  + There is no clear trend between disease type (acute vs. chronic) and disease condition (i.e: psychiatric drugs vs. cardiovascular).
  
```{r Most Popular, warning = FALSE, message = FALSE}
final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% most_popular_drugs) %>%
  plot_ly(y = ~avg_price, type = "box", color = ~trade_name, colors = "Set3") %>%
  layout(title = "Distribution of Average Price for Popular Drugs", xaxis = trade_name_axis, yaxis = avg_price_axis)
```

##### The Distribution of Average Price for Most Abused Drugs 

  + Ambien and Lunesta, which both treat sleep disorders, have the highest median of average drug price of $13.45 and $11.94 respectively. Focalin and Ritalin, which both treat ADHD, have the lowest median of average drug price of $0.97 each. 
  
```{r Case Study Analysis, warning = FALSE, message = FALSE}
final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% most_abused_drugs) %>%
  group_by(trade_name) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~trade_name, colors = "Set3") %>%
  layout(title = "Distribution of Average Price for Most Abused Drugs", xaxis = trade_name_axis, yaxis = avg_price_axis)
```

##### The Distribution of Average Price for Most Prescribed Drugs Ordered by Descending Prescription Rates

  + Harvoni in the most expensive of the most prescribed drugs. Why is a drug that treats Hepatitis C so expensive?
  
  + Some explanation from [HuffPost](https://www.huffingtonpost.com/entry/why-hepatitis-c-drugs-are-expensive_us_5642840be4b08cda34868c8a): "There are an estimated three million Americans with hepatitis C; most of them boomer-aged, and most of them don’t know they have it. For 75 to 85 percent of those people, infection will lead to chronic hepatitis-related diseases like liver cancer, cirrhosis or liver disease. In fact, hepatitis C is the most common reason people have liver transplants in the U.S. And the new, better medications that could cure them of this potentially fatal disease are so expensive that government safety nets and private insurance companies are struggling to provide coverage to as many people who need them." 
  
    + Influences of pricing [Investopedia](https://www.investopedia.com/articles/investing/020316/how-pharmaceutical-companies-price-their-drugs.asp): uniqueness of the drug, how many other drugs are already available that treat the same condition, competition, have the potential to change the current practice of medicine used to treat the conditions the drugs target, extend or even save lives. 
  
  + If we exclude Harvoni, we can better see the box plots of the other drugs.
  
    + As prescription rates decrease, average drug price per tablet does not display any discernible trend.
    
```{r, warning = FALSE, message = FALSE}
final_dataset %>%
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% top_prescribed_drugs_sales) %>%
  ungroup() %>%
  mutate(trade_name = factor(trade_name)) %>%
  mutate(trade_name_presc = fct_relevel(trade_name, c("Harvoni", "Januvia", "Crestor","Xarelto","Eliquis", "Truvada"))) %>%
  group_by(trade_name) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~trade_name_presc, colors = "Set3") %>%
  layout(title = "Distribution of Average Price for Most Prescribed Drugs", xaxis = trade_name_axis, yaxis = avg_price_axis)


final_dataset %>% #without harvoni
  filter(!is.na(avg_price)) %>%
  filter(trade_name %in% top_prescribed_drugs_sales) %>%
  filter(trade_name != "Harvoni") %>%
  ungroup() %>%
  mutate(trade_name = factor(trade_name)) %>%
  mutate(trade_name_presc = fct_relevel(trade_name, c("Januvia", "Crestor","Xarelto","Eliquis", "Truvada"))) %>%
  group_by(trade_name) %>% 
  plot_ly(y = ~avg_price, type = "box", color = ~trade_name_presc, colors = "Set3") %>%
  layout(title = "Distribution of Average Price for Most Prescribed Drugs", xaxis = trade_name_axis, yaxis = avg_price_axis)
```

### Project Website And Shiny Application
```{r project_website, warning = FALSE, message = FALSE}
#https://josiealford14.github.io/p8105_final_jmmm/
#https://josiealford14.shinyapps.io/p8105_final_jmmm_shiny/
```

#### **Limitations**

There are a couple of important limitations of our analysis.  Because of the way subsetted/joined the datasets, there was a substantial amount of lost data, which could impact our findings.  Additionally, the dataset used classify diseases as acute or chronic may not have been comprehensive which may have resulted in misclassification of disease type. Also, the validity of the two sample independent t-tests may be compromised because the average price variable violates the normality assumption.

### **Conclusion**

Based on our exploratory analyses, the overall average drug price has increased from 2013 to 2017. We explored NIH funding,  drug need (prevalence), sales, and advertising and found that none of these factors influenced average drug price.  However, there were other factors such as the number of currently effective treatment options for the condition and the public health significance.

For future research, we would like to explore how various cultural shifts in American popular culture influence the abuse of highly addictive prescription drugs such as Xanax and Percoset. Additionally, examining how pricing of opioids and benzodiazepines affect addiction and dependence rates is a potentially informative research pursuit.  For a similar analysis, we suggest including drugs in solution form in the analysis and finding a better way to join the dataset to avoid as much loss of data.

