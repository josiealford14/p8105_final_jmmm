---
title: "p8105_final_jmmm"
author: "MeOak/Muhire/Manali/Josie"
date: "10/31/2017"
output: html_document
---

```{r}
#project website. can you see it? https://josiealford14.github.io/therealcostofdrugs/
```

```{r load_packages, message = FALSE}
library(tidyverse)
library(dplyr)
library(rvest)
library(httr)
library(janitor)
library(stringr)
library(forcats)
library(tidytext)
library(viridis)
library(broom)
```

### **Dataset 1: Drug Prices**

* Looking at the National Drug Acquisition Cost dataset:

```{r tidy_drug_price, cache = TRUE}
# url = "https://data.medicaid.gov/resource/tau9-gfwr.csv"
# drug_price =
#   GET(url, query = list("$limit" = 9999999)) %>%
#   content("parsed") %>%
#   clean_names()
#   
drug_price =
  read_csv("./data/drug_price.csv") %>%
  clean_names()
```

* The raw `drug_price` dataset is huge and takes a while to load.
* It contains weekly drug prices from november 2013 to october 2017 recorded. There are `r drug_price %>% nrow()` observations and `r drug_price %>% ncol()` variables in the dataset:
    + `as_of_date`: date of data posting
    + `classification_for_rate_setting`: indicates whether, for NADAC calculation, the NDC was considered brand (‘B’) or generic (‘G’) or brand (‘B’) approved under an Abbreviated New Drug Application (ANDA) (‘B-ANDA’).
    + `corresponding_generic_drug_effecitve_date`:  effective date of when the Corresponding Generic Drug NADAC Per Unit is assigned to a multiple source brand drug NDC
    + `corresponding_generic_drug_nadac_per_unit`: NADAC for the corresponding generic drug
    + `effective_date`: effective date of the NADAC Per Unit cost
    + `explanation_code`: codes that pertain to how the NADAC was calculated. see explanation code
descriptions [here](https://www.medicaid.gov/medicaid-chip-program-information/by-topics/prescription-drugs/ful-nadac-downloads/nadacdatadefinitions.pdf)
    + `nadac_per_unit`: National Average Drug Acquisition Cost per unit
    + `ndc`:  11-digit FDA code that includes the labeler code, product code, and package code
    + `ndc_description`: drug name, strength, and dosage form of the drug 
    + `otc`: over-the-counter (OTC) product (‘Y’ or ‘N’)
    + `pharmacy_type_indicator`: source of pharmacy survey data used to calculate the NADAC. ‘ C/I’ indicates data was collected from surveys of Chain/Independent pharmacies. Other pharmacy type indicators are not used at this time.
    + `pricing_unit`:  pricing unit for the associated NDC (‘ML’, ‘GM’ or ‘EA’)
* We will focus on the variables `effective_date`, `ndc`, `ndc_description`, `otc`, `classification_for_rate_setting`, `pricing_unit`, and `nadac_per_unit`. We will rename the variables `effective_date`, `ndc_description`, `classification_for_rate_setting`, and `nadac_per_unit` as `date`, `drug_name`, `drug_type`, and `unit_price` respectively. We will also split the `date` variable into the `year`, `month` and `date` variables.

```{r rename_split_date}
drug_price = 
  drug_price %>%
  rename(date = effective_date,
         drug_name = ndc_description,
         drug_type = classification_for_rate_setting,
         unit_price = nadac_per_unit) %>%
  separate(date, into = c("year", "month", "date")) %>%
  mutate(grams = drug_name,
         grams = str_replace_all(grams,"[A-Z]", "")) %>%
  select(year, month, date, ndc, drug_name, grams, pricing_unit, unit_price, drug_type, otc, everything())
drug_price
```

* We look at the yearly distribution of drug prices for a few drugs. Some drugs have skewed price distributions and the median (instead of the mean) price might be the better measure to use in the analyses. Also, it might be worth creating a shiny app for people to view the price distributions for various drugs.

```{r drug_price_distr}
drug_price %>%
  filter(drug_name == "RISPERIDONE 4 MG TABLET") %>%
  ggplot(aes(x = year, y = unit_price)) + geom_violin(aes(fill = year), color = "blue", alpha = .5)
```

* **Points to consider:**
    + Some unit prices are listed as price per grams or price per milliliters or price per tablet We need to create a price variable with the appropriate unit price if we want to compare drug prices. One way to do this is to convert all unit prices to price per grams by dividing the price of each tablet by the tablet weight and by using the approximate relationship 1ml = 1gm.

### **Dataset 2: Funding for Research**

*The NIH RCDC Report
*This dataset contains the annual support for various disease categories based on grants, contracts, and other funding mechanisms used across the National Institutes of Health (NIH).  Prevalence and mortality data included in this dataset is from the National Center for Health Statistics (NCHS) at the Centers for Disease Control & Prevention (CDC).

```{r}
url = "https://report.nih.gov/categorical_spending.aspx"
NIH_xml = read_html(url)
NIH_funding = (NIH_xml %>% html_nodes(css = "table"))[[3]] %>% html_table() %>% as_tibble()
NIH_funding = NIH_funding %>%
  clean_names() %>%
  mutate(US_mortality_2015 = x2015_us_mortality_19)

NIH_funding$x2015_us_prevalence_standard_error_19  = recode(NIH_funding$x2015_us_prevalence_standard_error_19 , "-" = "NA")
NIH_funding$US_mortality_2015 = recode(NIH_funding$US_mortality_2015, "-" = "NA")

NIH_funding = NIH_funding %>%
  separate(x2015_us_prevalence_standard_error_19, into = c("prevalence", "remove"), sep = "\\%") %>%
  select(-x2015_us_mortality_19, -remove)
NIH_funding$fy_2013actual = recode(NIH_funding$fy_2013actual, "+" = "NNA")
NIH_funding$fy_2014actual = recode(NIH_funding$fy_2014actual, "+" = "NNA")
NIH_funding$fy_2015actual = recode(NIH_funding$fy_2015actual, "+" = "NNA")
NIH_funding$fy_2016actual = recode(NIH_funding$fy_2016actual, "+" = "NNA")

NIH_funding = NIH_funding %>%
  mutate(fy_2013 = as.numeric(substring(fy_2013actual, 2))) %>%
  mutate(fy_2014 = as.numeric(substring(fy_2014actual, 2))) %>%
  mutate(fy_2015 = as.numeric(substring(fy_2015actual, 2))) %>%
  mutate(fy_2016 = as.numeric(substring(fy_2016actual, 2))) %>%
  mutate(fy_2017 = as.numeric(substring(fy_2017estimated_enacted, 2))) %>%
  mutate(fy_2018estimated = as.numeric(substring(fy_2018estimated, 2))) 

NIH_funding$prevalence = as.numeric(NIH_funding$prevalence)
NIH_funding$US_mortality_2015 = as.numeric(NIH_funding$US_mortality_2015)
  
NIH_funding = NIH_funding %>%
  select(-c(fy_2013actual, fy_2014actual, fy_2015actual, fy_2016actual, fy_2017estimated_enacted)) 

final_nih_funding = NIH_funding %>%
  clean_names %>%
  filter(!is.na(fy_2017)) %>% #eliminate entries with many missing values
  rename(disease = research_disease_areas_dollars_in_millions_and_rounded, 
         '2013' = fy_2013,
         '2014' = fy_2014,
         '2015' = fy_2015,
         '2016' = fy_2016,
         '2017' = fy_2017,
         "2018_estimated" = fy_2018estimated) %>%
  select(disease, prevalence, us_mortality_2015, "2013", "2014", "2015", "2016", "2017", "2018_estimated")


```

### **Dataset 3: Patents**

*The Patents dataset from the FDA Orange Book

```{r}
patents = read_csv("./data/patent.csv")
patents = patents %>% 
  clean_names() %>%
  mutate(drug_application_type = factor(appl_type, labels = c("NDA_or_innovator"))) %>%
  separate(patexp, into = c("month_pat_expires", "day_pat_expires", "year_pat_expires"), sep = "/") %>%
  separate(patent_no, into = c("patent_num", "pediatric_exclusivity_granted"), sep = "\\*")

patents$pediatric_exclusivity_granted[is.na(patents$pediatric_exclusivity_granted)] = "no"
patents$drugsub[is.na(patents$drugsub)] = "no"
patents$drugprod[is.na(patents$drugprod)] = "no"
patents$delist[is.na(patents$delist)] = "no"


patents = patents %>%
  mutate(pediatric_exclusivity_granted = factor(pediatric_exclusivity_granted, levels = c("no", "PED"), labels = c("No", "Yes"))) %>%
  mutate(drug_substance_flag = factor(drugsub, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(drug_prod_flag = factor(drugprod, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(patent_delisted = factor(delist, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  select(-drugsub, -drugprod, -patexpstr, -appl_type) %>%
  rename(pat_use_code = patuse)
patents
```

### **Dataset 4: Products**

*The Products dataset from the FDA Orange Book
```{r}
products = read_csv("./data/products.csv")
products = products %>%
  mutate(drug_application_type = factor(appl_type, levels = c("A", "N"), labels = c("ANDA_or_generic","NDA_or_innovator"))) %>%
  separate(appdate, into = c("approval_month", "approval_day", "approval_year"), sep = "/") %>%
  #separate(doseform, into = c("form", "release_type"), sep = ",")
  mutate(type = factor(type)) %>%
  mutate(ref_listed_drug = factor(rld)) %>%
  mutate(ref_std = factor(rs)) %>%
  select(-appl_type, -appdatestr, -rld, -rs, -dfroute)
products
```

### **Dataset 5: Exclusivity**

We load and tidy the `exclusivity` dataset

```{r tidy_exclusivity}
exclusivity = read_csv("./data/exclusivity.csv") %>%
  clean_names() %>%
  separate(excldate, into = c("month", "date", "year")) %>%
  select(year, month, date, appl_type, everything())
exclusivity
```

The tidied `exclusivity` dataset has `r exclusivity %>% nrow` observations and `r exclusivity %>% ncol` variables:

* `year`, `month`, and `date` the exclusivity expires
* `appl_type`: type of new drug application approval. New Drug Applications (NDA or innovator) are "N". Abbreviated New Drug Applications (ANDA or generic) are “A”.
* `appl_no`: FDA assigned number to the application.  Format is nnnnnn.
* `product_no`: FDA assigned number to identify the application products. Each strength is a separate product. May repeat for multiple part products.  Format is nnn.
* `exclcode`: Code to designate exclusivity granted by the FDA to a drug product.  Format is nnnnnnnnnn.
* `excldatestr`: The date the exclusivity expires. Format is MMM DD, YYYY.

### **Dataset 6: Ingredient**

We load the `ingredient` dataset. 

```{r tidy_ingredients}
ingredient = read_csv("./data/ingredient.csv") %>%
  clean_names() %>%
  select(singnum, singredient, everything())
ingredient
```

The tidied `ingredient` dataset has `r ingredient %>% nrow` observations and `r ingredient %>% ncol` variables:

* `singnum`: The number assigned to the single ingredient for each product.
* `singredient`: each single ingredient in the product.
* `ingredient`: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.