---
title: "p8105_final_jmmm"
author: "MeOak/Muhire/Manali/Josie"
date: "10/31/2017"
output: html_document
---

```{r project_website}
#project website. can you see it? https://josiealford14.github.io/therealcostofdrugs/
```

```{r load_packages, message = FALSE}
library(tidyverse)
library(dplyr)
library(rvest)
library(httr)
library(janitor)
library(stringr)
library(forcats)
library(tidytext)
library(viridis)
library(broom)
library(plotly)
```

### **Dataset 1: Drug Prices**

* Looking at the National Drug Acquisition Cost dataset:

```{r tidy_drug_price}

# # API code
# url = "https://data.medicaid.gov/resource/tau9-gfwr.csv"
# drug_price =
#   GET(url, query = list("$limit" = 9999999)) %>%
#   content("parsed") %>%
#   clean_names()

# # CSV code
drug_price =
  read_csv("../data/drug_price.csv") %>%
  clean_names()
```

* The raw `drug_price` dataset is huge and takes a while to load.
* It contains weekly drug prices from november 2013 to october 2017 recorded. There are `r drug_price %>% nrow()` observations and `r drug_price %>% ncol()` variables in the dataset:
    + `as_of_date`: date of data posting
    + `classification_for_rate_setting`: indicates whether, for NADAC calculation, the NDC was considered brand (‘B’) or generic (‘G’) or brand (‘B’) approved under an Abbreviated New Drug Application (ANDA) (‘B-ANDA’).
    + `corresponding_generic_drug_effecitve_date`:  effective date of when the Corresponding Generic Drug NADAC Per Unit is assigned to a multiple source brand drug NDC
    + `corresponding_generic_drug_nadac_per_unit`: NADAC for the corresponding generic drug
    + `effective_date`: effective date of the NADAC Per Unit cost
    + `explanation_code`: codes that pertain to how the NADAC was calculated. see explanation code
descriptions [here](https://www.medicaid.gov/medicaid-chip-program-information/by-topics/prescription-drugs/ful-nadac-downloads/nadacdatadefinitions.pdf)
    + `nadac_per_unit`: National Average Drug Acquisition Cost per unit
    + `ndc`:  11-digit FDA code that includes the labeler code, product code, and package code
    + `ndc_description`: drug name, strength, and dosage form of the drug 
    + `otc`: over-the-counter (OTC) product (‘Y’ or ‘N’)
    + `pharmacy_type_indicator`: source of pharmacy survey data used to calculate the NADAC. ‘ C/I’ indicates data was collected from surveys of Chain/Independent pharmacies. Other pharmacy type indicators are not used at this time.
    + `pricing_unit`:  pricing unit for the associated NDC (‘ML’, ‘GM’ or ‘EA’)
* We will focus on the variables `effective_date`, `ndc`, `ndc_description`, `otc`, `classification_for_rate_setting`, `pricing_unit`, and `nadac_per_unit`. We will rename the variables `effective_date`, `ndc_description`, `classification_for_rate_setting`, and `nadac_per_unit` as `date`, `drug_name`, `drug_type`, and `unit_price` respectively. We will also split the `date` variable into the `year`, `month` and `date` variables.

```{r rename_split_date}
drug_price = 
  drug_price %>%
  rename(trade_name = ndc_description,
         drug_type = classification_for_rate_setting,
         unit_price = nadac_per_unit) %>%
  separate(effective_date, into = c("year", "month", "date")) %>%
  mutate(grams = str_replace_all(trade_name,"[A-Z]", ""),
         trade_name = str_replace(trade_name, "[0-9]", "_"),
         otc = recode(otc, "Y" = "yes", "N" = "no"),
         otc = str_to_title(otc)) %>% 
  separate(trade_name, into = c("trade_name", "remove"), sep = "_") %>%
  mutate(trade_name = str_to_title(trade_name),
         otc = as.factor(otc)) %>% 
  mutate(dupl_drug_name = trade_name) %>%
  separate(dupl_drug_name, into = c("dupl_drug_name", "remove1")) %>% 
  select(-c(remove, remove1, date, x1)) %>% 
  select(trade_name, everything())

drug_price
```

* We look at the yearly distribution of drug prices for a few drugs. Some drugs have skewed price distributions and the median (instead of the mean) price might be the better measure to use in the analyses. Also, it might be worth creating a shiny app for people to view the price distributions for various drugs.

```{r drug_price_distr}
drug_price %>%
  filter(trade_name == "Enema") %>%
  ggplot(aes(x = year, y = unit_price)) + geom_violin(aes(fill = year), color = "blue", alpha = .5)
```

* **Points to consider:**
    + Some unit prices are listed as price per grams or price per milliliters or price per tablet We need to create a price variable with the appropriate unit price if we want to compare drug prices. One way to do this is to convert all unit prices to price per grams by dividing the price of each tablet by the tablet weight and by using the approximate relationship 1ml = 1gm.

### **Dataset 2: Funding for Research**

* The NIH RCDC Report
* This dataset contains the annual support for various disease categories based on grants, contracts, and other funding mechanisms used across the National Institutes of Health (NIH).  Prevalence and mortality data included in this dataset is from the National Center for Health Statistics (NCHS) at the Centers for Disease Control & Prevention (CDC).
*Funding for 2018 are estimated figures.
```{r load_funding}
url = "https://report.nih.gov/categorical_spending.aspx"
NIH_xml = read_html(url)
NIH_funding = (NIH_xml %>% html_nodes(css = "table"))[[3]] %>% html_table() %>% as_tibble()
NIH_funding = NIH_funding %>%
  clean_names() %>%
  mutate(US_mortality_2015 = x2015_us_mortality_19)

NIH_funding$x2015_us_prevalence_standard_error_19  = recode(NIH_funding$x2015_us_prevalence_standard_error_19 , "-" = "NA")
NIH_funding$US_mortality_2015 = recode(NIH_funding$US_mortality_2015, "-" = "NA")

NIH_funding = NIH_funding %>%
  separate(x2015_us_prevalence_standard_error_19, into = c("prevalence", "remove"), sep = "\\%") %>%
  select(-x2015_us_mortality_19, -remove)
NIH_funding$fy_2013actual = recode(NIH_funding$fy_2013actual, "+" = "NNA")
NIH_funding$fy_2014actual = recode(NIH_funding$fy_2014actual, "+" = "NNA")
NIH_funding$fy_2015actual = recode(NIH_funding$fy_2015actual, "+" = "NNA")
NIH_funding$fy_2016actual = recode(NIH_funding$fy_2016actual, "+" = "NNA")

NIH_funding = NIH_funding %>%
  mutate(fy_2013 = as.numeric(substring(fy_2013actual, 2))) %>%
  mutate(fy_2014 = as.numeric(substring(fy_2014actual, 2))) %>%
  mutate(fy_2015 = as.numeric(substring(fy_2015actual, 2))) %>%
  mutate(fy_2016 = as.numeric(substring(fy_2016actual, 2))) %>%
  mutate(fy_2017 = as.numeric(substring(fy_2017estimated_enacted, 2))) %>%
  mutate(fy_2018estimated = as.numeric(substring(fy_2018estimated, 2))) 

NIH_funding$prevalence = as.numeric(NIH_funding$prevalence)
NIH_funding$US_mortality_2015 = as.numeric(NIH_funding$US_mortality_2015)
  
NIH_funding = NIH_funding %>%
  select(-c(fy_2013actual, fy_2014actual, fy_2015actual, fy_2016actual, fy_2017estimated_enacted))

final_NIH_funding = NIH_funding %>%
  rename(disease = research_disease_areas_dollars_in_millions_and_rounded, 
         '2013' = fy_2013,
         '2014' = fy_2014,
         '2015' = fy_2015,
         '2016' = fy_2016,
         '2017' = fy_2017,
         '2018' = fy_2018estimated) %>%
  gather(key = "year", value = funding, c("2013", "2014", "2015", "2016", "2017", "2018"))

rm(NIH_funding)

final_NIH_funding
```

### **Dataset 3: Patents**

* The Patents dataset from the FDA Orange Book
* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* New Drug Application Type: The type of new drug application approval, either New Drug Applications(NDA or innovator) or Abbreviated New Drug Applications(ANDA or generic)

* New Drug Application (NDA) Number (appl_no) : The FDA assigned number to the application. 

* Product Number: The FDA assigned number to identify the application products.  Each strength is a separate product.  May repeat for multiple part products. 

* Patent Number (patent_num): Patent numbers as submitted by the applicant holder for patents covered by the statutory provisions.  May repeat for multiple applications and multiple products. 

* Pediatric Exclusivity Granted: Yes or No.  Was pediatric exclusivity granted by the agency?

* Patent Expire Date: The date the patent expires as submitted by the applicant holder including applicable extensions.  This was split into Year, Month, and Day variables

* Drug Substance Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug substance flag indicating the sponsor submitted the patent as claiming the drug substance.   

* Drug Product Flag: Patents submitted on FDA Form 3542 and listed after August 18, 2003 may have a drug product flag indicating the sponsor submitted the patent as claiming the drug product.   

* Patent Use Code: Code to designate a use patent that covers the approved indication or use of a drug product.  May repeat for multiple applications, multiple products and multiple patents.

* Patent Delist Request Flag: Sponsor has requested patent be delisted.  This patent has remained listed because, under Section 505(j)(5)(D)(i) of the Act, a first applicant may retain eligibility for 180-day exclusivity based on a paragraph IV certification to this patent for a certain period.  Applicants under Section 505(b)(2) are not required to certify to patents where this flag is set to Y.

```{r load_patents}
patents = read_csv("./data/patent.csv")
patents = patents %>% 
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "N" = "B")) %>%
  separate(patexp, into = c("month_pat_expires", "day_pat_expires", "year_pat_expires"), sep = "/") %>%
  separate(patent_no, into = c("patent_num", "pediatric_exclusivity_granted"), sep = "\\*")

patents$pediatric_exclusivity_granted[is.na(patents$pediatric_exclusivity_granted)] = "no"
patents$drugsub[is.na(patents$drugsub)] = "no"
patents$drugprod[is.na(patents$drugprod)] = "no"
patents$delist[is.na(patents$delist)] = "no"

patents = patents %>%
  mutate(pediatric_exclusivity_granted = factor(pediatric_exclusivity_granted, levels = c("no", "PED"), labels = c("No", "Yes"))) %>%
  mutate(drug_substance_flag = factor(drugsub, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(drug_prod_flag = factor(drugprod, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  mutate(patent_delisted = factor(delist, levels = c("no", "Y"), labels = c("no", "yes"))) %>%
  select(-drugsub, -drugprod, -patexpstr) %>%
  rename(pat_use_code = patuse)
patents
```

### **Dataset 4: Products**

*The Products dataset from the FDA Orange Book

* Below is a description of the dataset and variables from https://www.fda.gov/Drugs/InformationOnDrugs/ucm129689.htm

* Ingredient: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

* Dose form;The product dosage form

* Route:  Product dosage route 

* Trade_Name: The trade name of the product as shown on the labeling.

* Applicant: The firm name holding legal responsibility for the new drug application.  The firm name is condensed to a maximum twenty character unique string.

* Strength: The potency of the active ingredient.  May repeat for multiple part products.

* Drug Application Type: The type of new drug application approval. NDA orANDA as for patents dataset.

* New Drug Application (NDA) Number: The FDA assigned number to the application.

* Product Number: The FDA assigned number to identify the application products. Each strength is a separate product.  May repeat for multiple part products.

* Therapeutic Equivalence (TE) Code: The TE Code indicates the therapeutic equivalence rating of generic to innovator Rx products.

* Approval Date: The date the product was approved as stated in the FDA approval letter to the applicant. Products approved prior to the January 1, 1982 contain the phrase: "Approved prior to Jan 1, 1982".  This separated into Year, Month, and Day variables.

* Reference Listed Drug (RLD) Updated: The RLD is a drug product approved under section 505(c) of the FD&C Act for which FDA has made a finding of safety and effectiveness. In the electronic Orange Book, an RLD is identified by “RLD” in the RLD column.

* Reference Standard (RS) New! :A “reference standard” is the drug product selected by FDA that an applicant seeking approval of an ANDA must use in conducting an in vivo bioequivalence study required for approval of an ANDA.  In the electronic Orange Book, a reference standard is identified by “RS” in the RS column.

*Type: The group or category of approved drugs. RX (prescription), OTC (over the counter), or DISCN (discontinued).

*Applicant Full Name: The full name of the firm holding legal responsibility for the new drug application. 

```{r load_products}
products = read_csv("./data/products.csv")
products = products %>%
  rename(drug_type = appl_type,
         otc = type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B"),
         otc = recode(otc, "OTC" = "yes", "RX" = "no", "DISCN" = "no")) %>%
  separate(appdate, into = c("approval_month", "approval_day", "approval_year"), sep = "/") %>%
  #separate(doseform, into = c("form", "release_type"), sep = ",")
  mutate(otc = factor(otc)) %>%
  mutate(ref_listed_drug = factor(rld)) %>%
  mutate(ref_std = factor(rs)) %>%
  select(-appdatestr, -rld, -rs, -dfroute)
products
```

### **Dataset 5: Exclusivity**

We load and tidy the `exclusivity` dataset

```{r tidy_exclusivity}
exclusivity = read_csv("./data/exclusivity.csv") %>%
  clean_names() %>%
  rename(drug_type = appl_type) %>% 
  mutate(drug_type = recode(drug_type, "A" = "G", "N" = "B")) %>% 
  separate(excldate, into = c("month_excl_expires", "date_excl_expires", "year_excl_expires"))
exclusivity
```

The tidied `exclusivity` dataset has `r exclusivity %>% nrow` observations and `r exclusivity %>% ncol` variables:

* `year`, `month`, and `date` the exclusivity expires
* `appl_type`: type of new drug application approval. New Drug Applications (NDA or innovator) are "N". Abbreviated New Drug Applications (ANDA or generic) are “A”.
* `appl_no`: FDA assigned number to the application.  Format is nnnnnn.
* `product_no`: FDA assigned number to identify the application products. Each strength is a separate product. May repeat for multiple part products.  Format is nnn.
* `exclcode`: Code to designate exclusivity granted by the FDA to a drug product.  Format is nnnnnnnnnn.
* `excldatestr`: The date the exclusivity expires. Format is MMM DD, YYYY.

### **Dataset 6: Ingredient**

We load the `ingredient` dataset. 

```{r tidy_ingredients}
ingredient = read_csv("./data/ingredient.csv") %>%
  clean_names() %>%
  select(singnum, singredient, everything())
ingredient
```

The tidied `ingredient` dataset has `r ingredient %>% nrow` observations and `r ingredient %>% ncol` variables:

* `singnum`: The number assigned to the single ingredient for each product.
* `singredient`: each single ingredient in the product.
* `ingredient`: The active ingredient(s) for the product. Multiple ingredients are in alphabetical order, separated by a semicolon.

### **Dataset 7: Drug by Condition**

Scraping data on drugs per condition from [this website](https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/A)

```{r scape_drug_disease}

urls = paste("https://www.centerwatch.com/drug-information/fda-approved-drugs/medical-conditions/", toupper(letters), sep = "")

get_drug_disease = function(url) {
  
  disease_data = read_html(url) %>% 
  html_nodes(css = ".ToggleDrugCategory") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(disease = value)
  
  drug_data = read_html(url) %>% 
  html_nodes(css = ".CategoryListSection a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug = value)
  
  drug_disease_data = read_html(url) %>% 
  html_nodes(css = "#MainColumn a:nth-child(1)") %>%
  html_text() %>% 
  as_tibble() %>% 
  mutate(key = value) %>% 
  rename(drug_disease = value)
  
  drug_disease_joined = left_join(drug_disease_data, drug_data, disease_data, by = "key") %>% 
  left_join(., disease_data, by = "key") %>%
  fill(disease) %>%
  select(-c(drug,drug_disease))
  
  toremove = drug_disease_joined %>% distinct(disease) %>% pull()
  
  drug_disease_joined = drug_disease_joined %>% 
  filter(!key %in% toremove) %>% 
  rename(drug = key) %>% 
  .[-c(1:29),]
  
  drug_disease_joined
}

drug_disease_data = map_df(urls, get_drug_disease) %>% 
  mutate(disease = str_to_title(disease),
         drug = str_to_title(drug)) %>% 
  rename(trade_name = drug) %>% 
  mutate(dupl_drug_name = trade_name) %>% 
  separate(dupl_drug_name, into = c("dupl_drug_name", "remove")) %>% 
  select(-remove)

drug_disease_data
```

The `drug_disease_data` contains `r drug_disease_data %>% nrow` observations and `r drug_disease_data %>%  ncol` variables:

* `drug`: the drug name
* `disease`: the disease name

### Combine Datasets into one 

```{r join_dataset}

#A: join datasets by ingredient for ingredient and products (left join)
#products = longer dataset + ingredient
product_ingredient = left_join(products, ingredient, by = "ingredient")
product_ingredient

#B: exclusivity and patents left join (more~less)
patent_exclusivity = left_join(patents, exclusivity, by = c("appl_no", "product_no", "drug_type"))
patent_exclusivity

#C: join A and B left join: "Orange Book." Thursday: meet to eliminate variables (inner join: only commonalities are preserved) #eliminate drugs that do not match
orange_book = left_join(product_ingredient, patent_exclusivity, by = c("appl_no", "product_no", "drug_type"))

orange_book = orange_book %>%
  mutate(ingredient = str_to_title(ingredient),
         doseform = str_to_title(doseform),
         route = str_to_title(route),
         trade_name = str_to_title(trade_name),
         applicant = str_to_title(applicant),
         otc = str_to_title(otc),
         appfull = str_to_title(appfull),
         singredient = str_to_title(singredient),
         strength = str_to_title(strength))
orange_book

# final goal: disease, funding, drug prices, and Orange Book

# eliminate unnecessary variables from orange book dataset
orange_book_clean = orange_book %>%
  rename(application_no = appl_no, 
         active_ingredient = singredient, 
         dose_form = doseform) %>%
  select(-c(ingredient, applicant, product_no, tecodestr, tecode, approval_day, ref_std, singnum, day_pat_expires, pat_use_code, drug_substance_flag, drug_prod_flag, exclcode, excldatestr, date_excl_expires)) %>% 
  mutate(dupl_drug_name = trade_name) %>% 
  separate(dupl_drug_name, into = c("dupl_drug_name", "remove")) %>% 
  select(-remove) %>% 
  select(trade_name, everything())


final_dataset = orange_book_clean %>% 
  inner_join(., drug_disease_data, by = "dupl_drug_name") %>% 
  select(-trade_name.y) %>% 
  rename(trade_name = trade_name.x) %>%
  distinct() %>%
  inner_join(., sample_n(drug_price, 100000), by = c("dupl_drug_name", "drug_type", "otc")) %>%
  select(-c(trade_name.y)) %>% 
  rename(trade_name = trade_name.x) %>% 
  distinct()


# # inner join of disease drug and orange book =y by trade_name
# final_dataset =
#   drug_price %>%
#   inner_join(., orange_book_clean, by = c("dupl_drug_name", "drug_type")) %>%
#   full_join(., drug_disease_data, by = "trade_name") %>%
#   full_join(., final_NIH_funding, by = "disease") %>%
#   arrange(trade_name) %>%
#   mutate(duplicates = trade_name) %>%
#   separate(duplicates, into = c("duplicates", "remove")) %>%
#   arrange(duplicates) %>%
#   select(trade_name, duplicates, everything())

# dpl = temp_joined_dataset %>%
#   pull(duplicates) %>%
#   unique()
# 
# trade_names = final_dataset %>% 
#   distinct(trade_name)
```

Josie
```{r}

```

```{r remove_var}
# Remomve some unecessary datasets
# rm(patent_exclusivity, product_ingredient)
```


```{r}
#inner join drug disease and orange book by drug name
#drug_disease_data_new = drug_disease_data %>%
  #separate(drug, into = c("trade_name", "active_ingredient"), sep = "\\(") %>%
  #mutate(trade_name = str_to_title(trade_name))
#partial matching for joining
#drug_disease_data_new_unique = drug_disease_data_new %>%
  #distinct(trade_name) %>%
  #pull()
#orange_book_clean_unique = orange_book_clean %>%
  #distinct(trade_name) %>%
  #pull()
#loop for partial matching
#x = vector("list")
#orange_book_matches = as.data.frame("")
#for (i in 1:length(drug_disease_data_new_unique)) {
 # orange_book_matches = agrep(drug_disease_data_new_unique[i], orange_book_clean$trade_name, ignore.case = TRUE)
#x = paste0(x, "")
#}


#partial_match = agrep(drug_disease_data_new$trade_name, orange_book_clean$trade_name)

#left join of drug_price and orange book by disease name


#final_dataset = inner_join(orange_book_clean, drug_price_new by = "active_ingredient")
```

Manali
```{r}
#do rare diseases recieve less funding?
#set.seed(1)
#final_dataset %>%
#  sample_n(50)%>%
#plot_ly(x~funding, y~prevalence, type = "scatter")

#does funding correlate with drug prices?

#final_dataset %>%
#  sample_n(50)%>%
#  plot_ly(x ~ price, y ~ funding, type = "scatter")


```

### **Muhire**

* How do the prices compare for each drug based on what they treat?  Possible case studies on most popular (perceived) drugs: Lipitor, Xanax, Celebrex, Prozac, Crestor, Nexium, Lisinopril, Zoloft

```{r}
# final_dataset


```

MeOak
```{r}

```
